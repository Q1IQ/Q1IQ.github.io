<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Q1IQ"><title>ida打patch学习 · Q1IQ</title><meta name="description" content="keypatch基本使用Edit -&amp;gt; Keypatch -&amp;gt; Patcher选中一行指令patch
可以输入汇编代码 nop啥的
Edit -&amp;gt; Keypatch -&amp;gt; Fill Range选中一定范围的指令一起patch
可以输入汇编代码
也可以输入16进制 “90” “"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">Q1IQ</a></h3><div class="description"><p>北京邮电大学 天枢Dubhe</p></div></div></div><ul class="social-links"></ul><script async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="footer"><a target="_blank" href="/"><span id="busuanzi_container_site_pv"></span><i class="fa fa-eye"></i>访问量<span id="busuanzi_value_site_pv"></span>次 |  <span id="busuanzi_container_site_uv"></span><i class="fa fa-user-md"></i>访客数<span id="busuanzi_value_site_uv"></span>人</a></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">Home</a></li><li><a href="/archives">Arquivo</a></li><li><a href="/links">Links</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>ida打patch学习</a></h3></div><div class="post-content"><h3 id="keypatch基本使用"><a href="#keypatch基本使用" class="headerlink" title="keypatch基本使用"></a>keypatch基本使用</h3><h5 id="Edit-gt-Keypatch-gt-Patcher"><a href="#Edit-gt-Keypatch-gt-Patcher" class="headerlink" title="Edit -&gt; Keypatch -&gt; Patcher"></a>Edit -&gt; Keypatch -&gt; Patcher</h5><p>选中一行指令patch</p>
<p>可以输入汇编代码 nop啥的</p>
<h5 id="Edit-gt-Keypatch-gt-Fill-Range"><a href="#Edit-gt-Keypatch-gt-Fill-Range" class="headerlink" title="Edit -&gt; Keypatch -&gt; Fill Range"></a>Edit -&gt; Keypatch -&gt; Fill Range</h5><p>选中一定范围的指令一起patch</p>
<p>可以输入汇编代码</p>
<p>也可以输入16进制 “90” “0x90” “90,91” “AAh”等。</p>
<h5 id="Edit-gt-Patch-program-gt-Apply-patches-to-input-file"><a href="#Edit-gt-Patch-program-gt-Apply-patches-to-input-file" class="headerlink" title="Edit -&gt; Patch program -&gt; Apply patches to input file"></a>Edit -&gt; Patch program -&gt; Apply patches to input file</h5><p>撤消上一个操作，而且可以撤销多次（好像是无限制？亲测20次还是能继续撤销（好哎</p>
<h5 id="Edit-gt-Patch-program-gt-Apply-patches-to-input-file-1"><a href="#Edit-gt-Patch-program-gt-Apply-patches-to-input-file-1" class="headerlink" title="Edit -&gt; Patch program -&gt; Apply patches to input file"></a>Edit -&gt; Patch program -&gt; Apply patches to input file</h5><p>将修改保存到一个新的二进制文件（这是ida原本就有的功能</p>
<h5 id="Edit-gt-Keypatch-gt-Search"><a href="#Edit-gt-Keypatch-gt-Search" class="headerlink" title="Edit -&gt; Keypatch -&gt; Search"></a>Edit -&gt; Keypatch -&gt; Search</h5><p>可以搜索汇编指令，不能直接搜索16进制</p>
<p>多条指令用 <code>;</code> 分隔</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190816211658.png" alt=""></p>
<h5 id="备注"><a href="#备注" class="headerlink" title="备注"></a>备注</h5><p>keypatch怕你忘了patch前的指令是啥，还加了个备注提醒。太贴心了</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190816213618.png" alt=""></p>
<h3 id="打patch方法"><a href="#打patch方法" class="headerlink" title="打patch方法"></a>打patch方法</h3><h5 id="UAF"><a href="#UAF" class="headerlink" title="UAF"></a>UAF</h5><p>增加置0的代码 </p>
<h5 id="栈溢出"><a href="#栈溢出" class="headerlink" title="栈溢出"></a>栈溢出</h5><p>改读的字节数 </p>
<p>gets改成read</p>
<p>增加栈空间 sub rsp,xxxx</p>
<p>过滤不可见字符</p>
<h5 id="堆溢出"><a href="#堆溢出" class="headerlink" title="堆溢出"></a>堆溢出</h5><p>改读的字节数 </p>
<p>gets改成read</p>
<p>增加malloc申请的空间</p>
<p>过滤不可见字符</p>
<h5 id="off-by-one-null"><a href="#off-by-one-null" class="headerlink" title="off by one/null"></a>off by one/null</h5><p>改读的字节数 </p>
<h5 id="整数溢出"><a href="#整数溢出" class="headerlink" title="整数溢出"></a>整数溢出</h5><p>有符号跳转改为无符号</p>
<h5 id="数组越界"><a href="#数组越界" class="headerlink" title="数组越界"></a>数组越界</h5><p>有符号跳转改为无符号</p>
<p>增加判断index大小的代码 </p>
<h5 id="格式化字符串"><a href="#格式化字符串" class="headerlink" title="格式化字符串"></a>格式化字符串</h5><p>增加合适的参数，将printf(xxx)改为printf(“%s”,xxxxx) </p>
<h5 id="条件竞争"><a href="#条件竞争" class="headerlink" title="条件竞争"></a>条件竞争</h5><p>把sleep等消耗时间的函数nop掉</p>
<p>加锁（麻烦）</p>
<h5 id="不太优雅的方法"><a href="#不太优雅的方法" class="headerlink" title="不太优雅的方法"></a>不太优雅的方法</h5><p>nop 掉 free </p>
<p>nop 掉 malloc </p>
<p>在读的字节中过滤一些特殊的字符 </p>
<p>打乱got表 </p>
<h3 id="Keystone库-安装踩坑"><a href="#Keystone库-安装踩坑" class="headerlink" title="Keystone库 安装踩坑"></a>Keystone库 安装踩坑</h3><p>环境：macOS<br>python:2.7</p>
<p>python终端报错信息如下，网上说少so库，我没在系统里找到。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import keystone</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</span><br><span class="line">  File &quot;/usr/local/lib/python2.7/site-packages/keystone/__init__.py&quot;, line 4, in &lt;module&gt;</span><br><span class="line">    from .keystone import Ks, ks_version, ks_arch_supported, version_bind, debug, KsError, __version__</span><br><span class="line">  File &quot;/usr/local/lib/python2.7/site-packages/keystone/keystone.py&quot;, line 75, in &lt;module&gt;</span><br><span class="line">    raise ImportError(&quot;ERROR: fail to load the dynamic library.&quot;)</span><br><span class="line">ImportError: ERROR: fail to load the dynamic library.</span><br></pre></td></tr></table></figure>

<p>解决方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//下载</span><br><span class="line">https://pypi.python.org/packages/9a/fc/ed0d3f46921bfaa612d9e8ce8313f99f4149ecf6635659510220c994cb72/keystone-engine-0.9.1-3.tar.gz</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//安装</span><br><span class="line">cd keystone-engine-0.9.1-3</span><br><span class="line">sudo python setup.py install</span><br></pre></td></tr></table></figure>


<p>这下终端不报错了，ida还是报错</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190816201043.png" alt=""></p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190816201957.png" alt=""><br>解决方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//查看keystone在哪</span><br><span class="line">Python 2.7.16 (default, Jun 19 2019, 07:41:28) </span><br><span class="line">[GCC 4.2.1 Compatible Apple LLVM 10.0.0 (clang-1000.11.45.5)] on darwin</span><br><span class="line">Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.</span><br><span class="line">&gt;&gt;&gt; import keystone</span><br><span class="line">&gt;&gt;&gt; print keystone</span><br><span class="line">&lt;module &apos;keystone&apos; from &apos;/usr/local/lib/python2.7/site-packages/keystone/__init__.pyc&apos;&gt;</span><br><span class="line">&gt;&gt;&gt; print keystone.arm_const</span><br><span class="line">&lt;module &apos;keystone.arm_const&apos; from &apos;/usr/local/lib/python2.7/site-packages/keystone/arm_const.pyc&apos;&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//将其复制到ida.app里</span><br><span class="line">$ sudo cp -r ./keystone /Applications/IDA\ Pro\ 7.0/ida.app/Contents/MacOS/python</span><br><span class="line">$ sudo cp -r ./keystone /Applications/IDA\ Pro\ 7.0/ida64.app/Contents/MacOS/python</span><br><span class="line">$ pwd</span><br><span class="line">/usr/local/lib/python2.7/site-packages</span><br></pre></td></tr></table></figure>
<p>最后重启ida</p>
<p>成功！<br><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190816203552.png" alt=""></p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2019-08-16</span><i class="fa fa-tag"></i><a class="tag" href="/tags/学习/" title="学习">学习 </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,http://q1iq.top/ida打patch学习/,Q1IQ,ida打patch学习,;" target="_blank" rel="noopener"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/ByteCtf-note_five%E4%B8%A4%E7%A7%8D%E8%A7%A3%E6%B3%95/" title="ByteCtf note_five两种解法">Post Anterior</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/pwnable-201906/" title="pwnable-201906">Próximo post</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":true,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"left","width":200,"height":400,"hOffset":400,"vOffset":0},"mobile":{"show":false},"react":{"opacity":0.7},"log":false});</script></body></html>